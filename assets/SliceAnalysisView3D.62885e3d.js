import{aM as D,ac as t,ad as s,ae as _,aN as f,u as P,fM as m,c as y,gy as V,aH as c,a8 as n,ea as L,fQ as b,aa as p,c7 as x,dB as C,cZ as z,dJ as $,dE as E,dH as G,d5 as M}from"./vendor.1dc52be5.js";import{p as A}from"./AnalysisView3D.dbcf3da8.js";import{L as B,x as O,j as R,M as F,y as j,h as U,g as k,p as q,K as H,c as I,C as K,e as T,i as J,n as N}from"./sliceToolUtils.612da53f.js";import{E as Q}from"./BuildingComponentSublayer.9ba3e6a8.js";import{b as Z}from"./LineVisualElement.bea542a9.js";import"./ImageMaterial.012e4446.js";import"./capabilities.ee85458d.js";const w=D.getLogger("esri.views.3d.analysis.Slice.SliceController");let h=class extends f{constructor(e){super(e),this._handles=new P,this._internalChange=!1,this._currentSlicePlane=null,this.state="ready"}get ready(){return this.state==="ready"}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",e=>{const i=e.item;i!=null&&(i instanceof m||i instanceof Q)?i instanceof m&&B(i)?(w.error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(i)&&e.preventDefault():(w.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())})),X(this.view,this),this._handles.add([y(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),y(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),y(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),y(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this._handles.add([y(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._set("state","ready"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.state!=="destroyed"&&(this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),Y(this.view,this),this._handles.destroy(),this.set("view",null),this._set("state","destroyed"))}async whenReady(){return await V(this,"ready"),this}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(O).flatMap(({sublayerViews:i})=>i.items))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,i=this._currentSlicePlane;if(c(i)&&c(e)||n(i)&&n(e)&&e.equals(i))return;let l=null,a=null;if(n(e)&&n(e.position)){const o=e.position.spatialReference,g=R(e,this.view);c(g)&&Z(this.analysis,o,w),l=F(g,this.view,{tiltEnabled:this.analysis.tiltEnabled},L()),n(l)&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=l,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,i=j(e,this.view,this.view.spatialReference,new U);let l=null;n(i)&&(l={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=l,this._internalChange=!0,this.analysis.shape=i,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(v)return;const e=S(this.view);if(this.analysisViewData.active)n(e.activeController)&&e.activeController!==this?(v=!0,e.activeController.analysisViewData.active=!1,v=!1):n(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(n(e.activeController)&&e.activeController!==this)return;n(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){this.state==="ready"&&W(this.view)}_updateLayerViews(){const e=n(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,i=[],l=a=>{"layers"in a?a.layers.forEach(l):i.push(a)};this.analysis.excludedLayers.forEach(l),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&i.indexOf(a.layer)<0),"sublayerViews"in a&&a.sublayerViews.forEach(o=>{o.slicePlaneEnabled=e&&i.indexOf(o.sublayer)<0}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};t([s({readOnly:!0})],h.prototype,"state",void 0),t([s()],h.prototype,"view",void 0),t([s()],h.prototype,"analysis",void 0),t([s()],h.prototype,"analysisViewData",void 0),t([s()],h.prototype,"ready",null),t([s()],h.prototype,"_allLayerAndSubLayerViews",null),h=t([_("esri.views.3d.analysis.Slice.SliceController")],h);const u=new Map;let v=!1;function W(e){const i=S(e).activeController;n(i)&&n(i.analysisViewData.plane)&&i.analysisViewData.visible?e.slicePlane=i.analysisViewData.plane:e.slicePlane=null}function X(e,i){u.has(e)||u.set(e,{all:[],activeController:null}),u.get(e).all.push(i)}function S(e){return u.get(e)}function Y(e,i){if(!u.has(e))throw new Error("view expected in global slice register");const l=u.get(e),a=l.all.lastIndexOf(i);if(a===-1)throw new Error("controller expected in global slice register");l.all.splice(a,1),l.all.length===0&&u.delete(e)}let r=class extends f{constructor(e){super(e),this._handles=new P,this._gridVisualElement=null,this._outlineVisualElement=null,this.state="pending",this.showGrid=!1,this.editable=!0}get ready(){return this.state==="ready"}initialize(){this._initialize()}async _initialize(){if(this.state==="destroyed"||this.state==="ready")return;await V(this.view,"ready",!0);const e=this.analysisViewData;if(c(e))throw new Error("expected internal object to be valid");this._gridVisualElement=k(this.view),this._outlineVisualElement=q(this.view),this._handles.add([y(()=>({visible:n(e.plane)&&this.analysisViewData.visible,active:this.analysisViewData.active,editable:this.editable,showGrid:this.showGrid}),i=>this._updateMaterials(i),b),y(()=>e.plane,i=>this._updatePlane(i),b)],"internal"),this._set("state","ready")}destroy(){this.state!=="destroyed"&&this.state!=="pending"&&(this._handles.destroy(),this._gridVisualElement=p(this._gridVisualElement),this._outlineVisualElement=p(this._outlineVisualElement),this.set("view",null),this._set("state","destroyed"))}async whenReady(){return await V(this,"ready"),this}_updatePlane(e){if(c(e))return;const i=x(z.get(),C(e.basis1),C(e.basis2),1),l=$(E.get(),i),a=H(e,E.get()),o=G(l,a,l);this._outlineVisualElement.transform=o,this._gridVisualElement.transform=o}_updateMaterials({visible:e,active:i,editable:l,showGrid:a}){this._outlineVisualElement.color=I,this._outlineVisualElement.width=l?K:T,this._outlineVisualElement.stipplePattern=i?null:M(5);const o=a?N:[0,0,0,0];this._gridVisualElement.backgroundColor=J,this._gridVisualElement.gridColor=o,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};t([s({readOnly:!0})],r.prototype,"state",void 0),t([s()],r.prototype,"view",void 0),t([s()],r.prototype,"analysis",void 0),t([s()],r.prototype,"analysisViewData",void 0),t([s()],r.prototype,"ready",null),t([s()],r.prototype,"showGrid",void 0),t([s()],r.prototype,"editable",void 0),r=t([_("esri.views.3d.analysis.Slice.SliceVisualization")],r);let d=class extends A(f){constructor(e){super(e),this.type="slice-view-3d",this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0,this.showGrid=!1,this.editable=!1}initialize(){this.analysisVisualization=new r({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new h({view:this.view,analysis:this.analysis,analysisViewData:this})}destroy(){this.analysisVisualization=p(this.analysisVisualization),this.analysisController=p(this.analysisController)}async when(){return await this.analysisVisualization.whenReady(),await this.analysisController.whenReady(),this}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController}}};t([s()],d.prototype,"type",void 0),t([s()],d.prototype,"analysis",void 0),t([s()],d.prototype,"plane",void 0),t([s()],d.prototype,"active",void 0),t([s({aliasOf:"analysisVisualization.showGrid"})],d.prototype,"showGrid",void 0),t([s({aliasOf:"analysisVisualization.editable"})],d.prototype,"editable",void 0),d=t([_("esri.views.3d.analysis.SliceAnalysisView3D")],d);const re=d;export{re as default};
