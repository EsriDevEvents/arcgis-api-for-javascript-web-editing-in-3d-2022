import{ac as u,ad as f,mj as j,ae as S,a7 as _,V as T,a8 as N,g as I}from"./vendor.1dc52be5.js";import{k as F,B as R}from"./rasterProjectionHelper.33d3a601.js";import{d as L}from"./popupUtils.b61067f9.js";const D=V=>{let l=class extends V{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}_getfullExtent(){return this.projectFullExtent(this.view.spatialReference)}get hasTilingEffects(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}get datumTransformation(){return F(_(this.layer.fullExtent),this.view.spatialReference,!0)}supportsSpatialReference(e){return!!this.projectFullExtent(e)}projectFullExtent(e){const r=_(this.layer.fullExtent),t=F(r,e,!1);return R(r,e,t)}async fetchPopupFeatures(e,r){const{layer:t}=this;if(!e)return Promise.reject(new T("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:t}));const{popupEnabled:a}=t,i=L(t,r);if(!a||!N(i))throw new T("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:a,popupTemplate:i});const s=[],{value:n,magdirValue:d}=await t.identify(e,{timeExtent:this.timeExtent});let g="";if(n&&n.length){var x,b;g=t.type==="imagery-tile"&&t.hasStandardTime()&&n[0]!=null?n.map(h=>t.getStandardTimeValue(h)).join(", "):n.join(", ");const p={ObjectId:0},v="Raster.ServicePixelValue";p[v]=this._formatAttributeValue(g,v);const y=(x=t.rasterInfo)==null||(b=x.attributeTable)==null?void 0:b.features;if(y&&y.length>0){const h=y.filter(o=>{const m=o.attributes.value||o.attributes.Value||o.attributes.VALUE;return String(m)===g});if(h.length>0){const o=h[0];if(o){for(const m in o.attributes)if(o.attributes.hasOwnProperty(m)){const w=this._rasterFieldPrefix+m;p[w]=this._formatAttributeValue(o.attributes[m],w)}}}}const E=t.rasterInfo.dataType;E!=="vector-magdir"&&E!=="vector-uv"||(p["Raster.Magnitude"]=d==null?void 0:d[0],p["Raster.Direction"]=d==null?void 0:d[1]);const c=new I(this.fullExtent.clone(),null,p);c.layer=t,c.sourceLayer=c.layer,s.push(c)}return s}_formatAttributeValue(e,r){if(typeof e=="string"){const t=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,a=this._getFieldInfo(t,r),i=a&&a.format;if(i){let s,n;return e.trim().indexOf(",")>-1?(s=",",n=s+" ",this._formatDelimitedString(e,s,n,i)):e.trim().indexOf(" ")>-1?(s=n=" ",this._formatDelimitedString(e,s,n,i)):this._formatNumberFromString(e,i)}}return e}_getFieldInfo(e,r){if(!e||!e.length||!r)return;const t=r.toLowerCase();let a;return e.some(i=>!(!i.fieldName||i.fieldName.toLowerCase()!==t&&i.fieldName.toLowerCase()!==t.replace(/ /g,"_"))&&(a=i,!0)),a}_formatDelimitedString(e,r,t,a){return e&&r&&t&&a?e.trim().split(r).map(i=>this._formatNumberFromString(i,a)).join(t):e}_formatNumberFromString(e,r){if(!e||!r)return e;const t=Number(e);return isNaN(t)?e:r.format(t)}};return u([f()],l.prototype,"layer",void 0),u([f(j)],l.prototype,"timeExtent",void 0),u([f()],l.prototype,"view",void 0),u([f()],l.prototype,"fullExtent",null),u([f()],l.prototype,"tileInfo",void 0),u([f({readOnly:!0})],l.prototype,"hasTilingEffects",null),l=u([S("esri.views.layers.ImageryTileLayerView")],l),l};export{D as m};
