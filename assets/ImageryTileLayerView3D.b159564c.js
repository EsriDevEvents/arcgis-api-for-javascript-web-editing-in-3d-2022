import{k7 as c,fF as g,fG as u,V as f,nc as b,a7 as I,aH as y,nd as w,k8 as v,ne as z,n3 as R,ac as o,ad as m,ae as T}from"./vendor.1dc52be5.js";import{m as x}from"./ImageryTileLayerView.11127cd7.js";import{i as S}from"./RefreshableLayerView.3b33c0ca.js";import"./rasterProjectionHelper.33d3a601.js";import"./popupUtils.b61067f9.js";let s=class extends x(S(c(g(u)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this.isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new f("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const e=b(this.view,"basemapTerrain.tilingSchemeLocked").then(()=>{const t=this.view.basemapTerrain.tilingScheme,{tileInfo:i}=this.layer,a=["png","png24","png32","jpg","mixed"].indexOf(i.format)>-1&&t.compatibleWith(i);this.isAlignedMapTile=a;const l=a?i:t.toTileInfo();this.tileInfo=l,this.updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition],()=>this.refresh())});this.addResolvingPromise(e)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null}get _blankTile(){const e=document.createElement("canvas"),t=e.getContext("2d"),[i,a]=this.tileInfo.size;return e.width=i,e.height=a,t.clearRect(0,0,i,a),t.getImageData(0,0,i,a)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){const e=this.tileInfo.lods,t=this.layer.tileInfo.lods,i=e[0].scale,a=t[t.length-1].scale;return this.levelRangeFromScaleRange(i,a)}_getfullExtent(){return this.projectFullExtent(this.view.basemapTerrain?this.view.basemapTerrain.spatialReference:this.view.spatialReference)}async fetchTile(e,t,i,a){const l=this.tileInfo,d=this._canSymbolizeInWebGL(),p={tileInfo:l,requestRawData:d,signal:I(a.signal),requestAsImageElement:this.isAlignedMapTile},n=await this.layer.fetchTile(e,t,i,p);if(n instanceof HTMLImageElement)return n;let h=n&&n.pixelBlock;if(y(h))return this._blankTile;if(!d&&(h=await this.layer.applyRenderer(n),y(h)))return this._blankTile;const r=new w([e,t,i],h,l.size[0],l.size[1]);return d?(r.symbolizerRenderer=this.layer.symbolizer.rendererJSON,r.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e)),r.transformGrid=n.transformGrid):r.isRendereredSource=!0,r.interpolation=this.layer.interpolation,r.bandIds=this.layer.bandIds,r}_getSymbolizerOptions(e){const t=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,t){return v(e,t,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){const e=z(this.view._stage.renderView.renderingContext.type);return(e.type===R.WEBGL2||e.supportsTextureFloat)&&this.layer.symbolizer.canRenderInWebGL}};o([m({readOnly:!0})],s.prototype,"_blankTile",null),o([m({readOnly:!0})],s.prototype,"imageFormatIsOpaque",null),o([m({readOnly:!0})],s.prototype,"hasMixedImageFormats",null),o([m({readOnly:!0})],s.prototype,"dataLevelRange",null),s=o([T("esri.views.3d.layers.ImageryTileLayerView3D")],s);const k=s;export{k as default};
