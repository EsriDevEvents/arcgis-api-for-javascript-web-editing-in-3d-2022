var Gt=Object.defineProperty;var Ye=Object.getOwnPropertySymbols;var Qt=Object.prototype.hasOwnProperty,Kt=Object.prototype.propertyIsEnumerable;var Ze=(e,t,i)=>t in e?Gt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,O=(e,t)=>{for(var i in t||(t={}))Qt.call(t,i)&&Ze(e,i,t[i]);if(Ye)for(var i of Ye(t))Kt.call(t,i)&&Ze(e,i,t[i]);return e};import{I as Jt,lO as De,af as Xt,us as Yt,ut as Zt,b7 as F,uu as ei,rr as et,rq as ti,dV as qe,uv as ii,a0 as dt,uw as si,ux as ut,aM as yt,hq as li,a5 as ht,h4 as pt,ac as v,ad as I,ae as ye,aN as mt,u as Ie,n as Pe,gN as ge,cR as ue,u6 as ri,gr as K,ke as ni,uy as ai,h2 as k,a7 as Ae,uz as G,na as oi,hc as tt,mB as oe,uA as ci,uB as di,uC as ui,ag as yi,r3 as hi,uD as pi,uE as mi,a8 as Ee,uF as fi,oB as gi,uG as bi,rl as d,uH as he,uI as xe,rp as ze,ro as vi,ft as U,uJ as Te,uK as _e,uL as _i,uM as He,uN as be,uO as Li,uP as P,f8 as wi}from"./vendor.1dc52be5.js";import{h as Si}from"./EffectView.c4d390fc.js";import{c as Ii}from"./ExportImageParameters.70091022.js";import{o as Ci}from"./rendererConversion.a8299b6f.js";import{l as Ai,M as Ei,A as $i,G as Ri,j as Vi,T as xi,E as zi,V as it,D as Ti}from"./renderUtils.3228987e.js";import{getSymbolLayerFill as ki}from"./previewSymbol3D.cd8a3859.js";import"./sublayerUtils.9294814a.js";import"./webStyleSymbolUtils.cf28ccef.js";const Fi=(e,t)=>{const i=e.featuresTilingScheme.getClosestInfoForScale(e.scale).level;return t!=null&&t.levels?t.levels[i]:null};function Mi(e,t){if(!e||!("visualVariables"in e)||!e.visualVariables)return null;const i=e.visualVariables.find(l=>l.type==="size"),s=Fi(t,i);return s?new Jt({field:i.field,minSize:s[2].size,minDataValue:s[2].value,maxSize:s[3].size,maxDataValue:s[3].value}):null}const Bi=/^-?(\d+)(\.(\d+))?$/i;function Ni(e,t){return e-t}function Oi(e,t){let i,s;return i=Number(e.toFixed(t)),i<e?s=i+1/10**t:(s=i,i-=1/10**t),i=Number(i.toFixed(t)),s=Number(s.toFixed(t)),[i,s]}function Di(e,t,i,s,l){const r=ve(e,t,i,s),n=r.previous==null||r.previous<=l,a=r.next==null||r.next<=l;return n&&a||r.previous+r.next<=2*l}function Le(e){const t=String(e),i=t.match(Bi);if(i&&i[1])return{integer:i[1].split("").length,fractional:i[3]?i[3].split("").length:0};if(t.toLowerCase().indexOf("e")>-1){const s=t.split("e"),l=s[0],r=s[1];if(l&&r){const n=Number(l);let a=Number(r);const o=a>0;o||(a=Math.abs(a));const u=Le(n);return o?(u.integer+=a,a>u.fractional?u.fractional=0:u.fractional-=a):(u.fractional+=a,a>u.integer?u.integer=1:u.integer-=a),u}}return{integer:0,fractional:0}}function ve(e,t,i,s){const l={previous:null,next:null};if(i!=null){const r=e-i,n=t-i-r;l.previous=Math.floor(Math.abs(100*n/r))}if(s!=null){const r=s-e,n=s-t-r;l.next=Math.floor(Math.abs(100*n/r))}return l}function we(e,t={}){const i=e.slice(0),{tolerance:s=2,strictBounds:l=!1,indexes:r=i.map((n,a)=>a)}=t;r.sort(Ni);for(let n=0;n<r.length;n++){const a=r[n],o=i[a],u=a===0?null:i[a-1],c=a===i.length-1?null:i[a+1],h=Le(o).fractional;if(h){let p,f=0,m=!1;for(;f<=h&&!m;){const _=Oi(o,f);p=l&&n===0?_[1]:_[0],m=Di(o,p,u,c,s),f++}m&&(i[a]=p)}}return i}const qi={maximumFractionDigits:20};function Pi(e){return De(e,qi)}const ft="<",gt=">",Hi=Zt("short-date");function bt(e,t,i,s){let l="";t===0?l=`${ft} `:t===i&&(l=`${gt} `);let r=null;return r=s?Yt(e,Hi):Pi(e),l+r}const Ui=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwcdIkqhiWn5fHwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6JrzFUAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwaeIkqhiWl5/HwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6sKxboAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwadJEqhiWl5fPwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu75+IUcAAAAASUVORK5CYII="];async function ke(e){if(!("visualVariables"in e)||!e.visualVariables)return null;const t=e.visualVariables.find(n=>n.type==="color");if(!t)return null;let i=null,s=null;if(t.stops){if(t.stops.length===1)return t.stops[0].color;i=t.stops[0].value,s=t.stops[t.stops.length-1].value}const l=i+(s-i)/2,{getColor:r}=await import("./vendor.1dc52be5.js").then(function(n){return n.xo});return r(t,l)}async function vt(e,t){const i=e.trailWidth||1,s=t||await ke(e)||e.color;return new Xt({cap:"butt",color:s,width:i})}const Wi=new F([64,64,64]);function _t(e,t){const i=[],s=e.length-1;return e.length===5?i.push(0,2,4):i.push(0,s),e.map((l,r)=>i.indexOf(r)>-1?bt(l,r,s,t):null)}async function st(e,t,i){let s=!1,l=[],r=[];if(e.stops){const u=e.stops;l=u.map(c=>c.value),s=u.some(c=>!!c.label),s&&(r=u.map(c=>c.label))}const n=l[0],a=l[l.length-1];if(n==null&&a==null)return null;const o=s?null:_t(l,i);return(await Promise.all(l.map(async(u,c)=>({value:u,color:e.type==="opacity"?await ji(u,e,t):(await import("./vendor.1dc52be5.js").then(function(h){return h.xo})).getColor(e,u),label:s?r[c]:o[c]})))).reverse()}async function ji(e,t,i=Wi){const s=new F(i),l=(await import("./vendor.1dc52be5.js").then(function(r){return r.xo})).getOpacity(t,e);return l!=null&&(s.a=l),s}function Gi(e){let t=!1,i=[],s=[];i=e.map(a=>a.value),t=e.some(a=>!!a.label),t&&(s=e.map(a=>a.label));const l=i[0],r=i[i.length-1];if(l==null&&r==null)return null;const n=t?null:_t(i,!1);return i.map((a,o)=>({value:a,color:Lt(a,e),label:t?s[o]:n[o]})).reverse()}function Lt(e,t){const{startIndex:i,endIndex:s,weight:l}=Qi(e,t);if(i===s)return t[i].color;const r=F.blendColors(t[i].color,t[s].color,l);return new F(r)}function Qi(e,t){let i=0,s=t.length-1;return t.some((l,r)=>e<l.value?(s=r,!0):(i=r,!1)),{startIndex:i,endIndex:s,weight:(e-t[i].value)/(t[s].value-t[i].value)}}function Ki(e,t){let i=[];if(e&&e.type==="multipart")e.colorRamps.reverse().forEach(function(s,l){l===0?i.push({value:t.max,color:new F(s.toColor),label:"high"}):i.push({value:null,color:new F(s.toColor),label:""}),l===e.colorRamps.length-1?i.push({value:t.min,color:new F(s.fromColor),label:"low"}):i.push({value:null,color:new F(s.fromColor),label:""})});else{let s,l;e&&e.type==="algorithmic"?(s=e.fromColor,l=e.toColor):(s=[0,0,0,1],l=[255,255,255,1]),i=[{value:t.max,color:new F(l),label:"high"},{value:t.min,color:new F(s),label:"low"}]}return i}function Ji(e){let t=e.colorStops,i=t.length-1;if(t&&t[0]){const s=t[i];s&&s.ratio!==1&&(t=t.slice(0),t.push(new ei({ratio:1,color:s.color})),i++)}return t.map((s,l)=>{let r="";return l===0?r="low":l===i&&(r="high"),{color:s.color,label:r,ratio:s.ratio}}).reverse()}const lt={HH:315,HL:45,LL:135,LH:225},Xi={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]};function Yi(e){if(!e)return;const{type:t}=e;if(t.indexOf("3d")>-1)return ki(e.symbolLayers.getItemAt(0));if(t==="simple-line"){const i=et(e);return i&&i.color}if(e.type==="simple-marker"&&(e.style==="x"||e.style==="cross")){const i=et(e);return i&&i.color}return ti(e)}function Zi(e,t){const i=t.HH.label,s=t.LL.label,l=t.HL.label,r=t.LH.label;switch(e){case"HH":default:return{top:i,bottom:s,left:l,right:r};case"HL":return{top:l,bottom:r,left:s,right:i};case"LL":return{top:s,bottom:i,left:r,right:l};case"LH":return{top:r,bottom:l,left:i,right:s}}}function es(e){const{focus:t,infos:i,numClasses:s}=e,l=Xi[s],r={};i.forEach(a=>{r[a.value]={label:a.label,fill:Yi(a.symbol)}});const n=[];for(let a=0;a<s;a++){const o=[];for(let u=0;u<s;u++){const c=r[l[a][u]];o.push(c.fill)}n.push(o)}return{type:"relationship-ramp",numClasses:s,focus:t,colors:n,labels:Zi(t,r),rotation:wt(t)}}function wt(e){let t=lt[e];return e&&t==null&&(t=lt.HH),t||0}const Fe=30,Me=12,St=[255,255,255],It=[200,200,200],se=[128,128,128],ts=20,is=5;function ss(e){return e.declaredClass==="esri.symbols.SimpleMarkerSymbol"}function ls(e){return e.declaredClass==="esri.symbols.PictureMarkerSymbol"}function rs(e){return e.declaredClass==="esri.symbols.SimpleLineSymbol"}function ns(e){return e.declaredClass==="esri.symbols.TextSymbol"}function as(e,t){const i=e.length-1;return e.map((s,l)=>bt(s,l,i,t))}async function os(e,t,i,s,l,r){var n,a;const o=t.legendOptions,u=o&&o.customValues,c=await us(e,i),h=!!c,p=!!u,f=t.minSize!=null&&t.maxSize!=null,m=t.stops&&t.stops.length>1,_=!!t.target;if(!h||!p&&!(f||m&&!_))return;const y=qe(c);let w=null,g=null,C=null;g=y&&!m?we([t.minDataValue,t.maxDataValue]):u||await hs(t,c,s,l);const S=e==null?void 0:e.authoringInfo,A=(S==null?void 0:S.type)==="univariate-color-size",$=A&&(S==null?void 0:S.univariateTheme)==="above-and-below";if(!g&&m&&(g=t.stops.map(R=>R.value),w=t.stops.some(R=>!!R.label),e.type==="flow"&&(g=we(g)),w&&(C=t.stops.map(R=>R.label))),y&&((n=g)==null?void 0:n.length)>2&&!$&&(g=[g[0],g[g.length-1]]),!g)return null;A&&((a=g)==null?void 0:a.length)!==5&&(g=Et({minSize:g[0],maxSize:g[g.length-1]}));const T=y?cs(e,g):null,W=ii(c),N=w?null:as(g,r);return(await Promise.all(g.map(async(R,q)=>{const D=y?T[q]:await ee(t,c,R,s,l);return{value:R,symbol:fs($&&e.type==="class-breaks"?ds(e,q):c,D),label:w?C[q]:N[q],size:D,outlineSize:W}}))).reverse()}function cs(e,t){const i=e==null?void 0:e.authoringInfo,s=(i==null?void 0:i.type)==="univariate-color-size";let l=[Me,Fe];if(s){const r=t[0],n=t[t.length-1],a=Me,o=Fe;l=t.map(u=>a+(u-r)/(n-r)*(o-a))}return s&&(i==null?void 0:i.univariateTheme)==="below"&&l.reverse(),l}function ds(e,t){const i=e.classBreakInfos,s=i.length,l=s<2||!(t>=2)?i[0].symbol.clone():i[s-1].symbol.clone();return e.visualVariables.some(r=>r.type==="color")&&(l.type.indexOf("3d")>-1?Ct(l):At(l)),l}async function us(e,t){if(e.type==="flow")return vt(e,t);let i=null,s=null;if(e.type==="simple")i=e.symbol;else if(e.type==="class-breaks"){const l=e.classBreakInfos;i=l&&l[0]&&l[0].symbol,s=l.length>1}else if(e.type==="unique-value"){const l=e.uniqueValueInfos;i=l&&l[0]&&l[0].symbol,s=l.length>1}return!i||ys(i)?null:(i=i.clone(),(t||s)&&(i.type.indexOf("3d")>-1?Ct(i):At(i)),i)}function ys(e){return e?dt(e)?!!e.symbolLayers&&e.symbolLayers.some(t=>t&&t.type==="fill"):e.type.indexOf("fill")!==-1:!1}function Ct(e){e.type==="line-3d"?e.symbolLayers.forEach(t=>{t.material={color:se}}):e.symbolLayers.forEach(t=>{t.type!=="icon"||t.resource&&t.resource.href?t.material={color:It}:(t.material={color:St},t.outline={color:se,size:1.5})})}function At(e){const t=si();if(e.type==="cim")ut(e,new F(It));else if(e.type.indexOf("line")!==-1)e.color=se;else if(e.color=t?se:St,e.type==="simple-marker")if(e.outline){var i,s;((i=e.outline)==null||(s=i.color)==null?void 0:s.toHex())==="#ffffff"&&(e.outline.color=se)}else e.outline={color:se,width:1.5}}async function hs(e,t,i,s){const l=(await import("./vendor.1dc52be5.js").then(function(a){return a.xo})).getSizeRangeAtScale(e,i,s),r=l&&Et(l);if(!l&&!r)return;let n=r.map(a=>ps(a,e,l));n=we(n);for(let a=1;a<n.length-1;a++){const o=await ms(e,t,n[a],n[a-1],i,s);o&&(n[a]=o[0],r[a]=o[1])}return n}function Et(e){const t=e.minSize,i=e.maxSize,s=is,l=(i-t)/(s-1),r=[];for(let n=0;n<s;n++)r.push(t+l*n);return r}function ps(e,t,i){const s=i.minSize,l=i.maxSize,r=t.minDataValue,n=t.maxDataValue;let a=null;return e<=s?a=r:e>=l?a=n:a=(e-s)/(l-s)*(n-r)+r,a}async function ms(e,t,i,s,l,r){const n=await ee(e,t,i,l,r),a=await ee(e,t,s,l,r),o=Le(i),u=o.fractional,c=ts;let h=o.integer,p=null,f=null;i>0&&i<1&&(p=10**u,h=Le(i*=p).integer);for(let m=h-1;m>=0;m--){const _=10**m;let y=Math.floor(i/_)*_,w=Math.ceil(i/_)*_;p!=null&&(y/=p,w/=p);let g=(y+w)/2;[,g]=we([y,g,w],{indexes:[1]});const C=await ee(e,t,y,l,r),S=await ee(e,t,w,l,r),A=await ee(e,t,g,l,r),$=ve(n,C,a,null),T=ve(n,S,a,null),W=ve(n,A,a,null);let N=$.previous<=c,R=T.previous<=c;if(N&&R&&($.previous<=T.previous?(N=!0,R=!1):(R=!0,N=!1)),N?f=[y,C]:R?f=[w,S]:W.previous<=c&&(f=[g,A]),f)break}return f}async function ee(e,t,i,s,l){const{getSize:r}=await import("./vendor.1dc52be5.js").then(function(n){return n.xo});return r(e,i,{scale:s,view:l,shape:t.type==="simple-marker"?t.style:null})}function fs(e,t){const i=e.clone();if(dt(i))qe(i)||i.symbolLayers.forEach(s=>{s.type!=="fill"&&(s.size=t)});else if(ss(i))i.size=t;else if(ls(i)){const s=i.width,l=i.height;i.height=t,i.width=t*(s/l)}else rs(i)?i.width=t:ns(i)&&i.font&&(i.font.size=t);return i}yt.getLogger("esri.renderers.support.utils");function gs(e){const i=Math.floor(Math.log10(Math.abs(e)))+1,s=i<4||i>6?4:i,l=1e6,r=Math.abs(e)>=l?"compact":"standard";return De(e,{notation:r,minimumSignificantDigits:2,maximumSignificantDigits:s})}const H=yt.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),bs="https://utility.arcgis.com/sharing/tools/legend",vs="esri.layers.ImageryLayer",_s="esri.layers.ImageryTileLayer",Ls="esri.layers.WCSLayer",pe=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,ws=new li({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),rt={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},me=new ht({size:6,outline:{color:[128,128,128,.5],width:.5}}),Ss=new pt({style:"solid"});function Be(e){return e.type==="flow"}function $t(e){return e.type==="vector-field"}function Rt(e){return e.type==="raster-colormap"}function Vt(e){return e.type==="raster-stretch"}function xt(e){return e.type==="raster-shaded-relief"}function te(e){return e.declaredClass==="esri.renderers.SimpleRenderer"}function ie(e){return e.declaredClass==="esri.renderers.ClassBreaksRenderer"}function Ne(e){return e.declaredClass==="esri.renderers.UniqueValueRenderer"}function zt(e){return e.declaredClass==="esri.renderers.HeatmapRenderer"}function Is(e){return Ue(e)||We(e)||je(e)||Cs(e)}function Cs(e){return e.declaredClass==="esri.renderers.PointCloudRGBRenderer"}function Ue(e){return e.declaredClass==="esri.renderers.PointCloudClassBreaksRenderer"}function We(e){return e.declaredClass==="esri.renderers.PointCloudStretchRenderer"}function je(e){return e.declaredClass==="esri.renderers.PointCloudUniqueValueRenderer"}function Tt(e){return e.declaredClass==="esri.renderers.DotDensityRenderer"}function As(e,t){return te(e)||ie(e)||Ne(e)||zt(e)||Tt(e)?t.type==="2d"||Ci(e):Vt(e)||Rt(e)||xt(e)||Ue(e)||We(e)||je(e)||$t(e)||Be(e)}function nt(e){return e.declaredClass==="esri.layers.BuildingSceneLayer"}function Es(e){return e.declaredClass==="esri.layers.VoxelLayer"}function $s(e){return e.declaredClass==="esri.layers.WMSLayer"}function Rs(e){return e.declaredClass==="esri.layers.WMTSLayer"}function at(e){return e.declaredClass==="esri.layers.MapImageLayer"}function Vs(e){return e.declaredClass==="esri.layers.TileLayer"}function xs(e){return e.declaredClass==="esri.layers.FeatureLayer"}function ce(e){return e.declaredClass===vs}function $e(e){return e.declaredClass===_s}function zs(e){return e.declaredClass===Ls}function Ts(e){return e.type==="stretch-ramp"}function ks(e){const t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo);return(t==null?void 0:t.type)==="univariate-color-size"}function Fs(e){const t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo);return(t==null?void 0:t.type)==="univariate-color-size"&&(t==null?void 0:t.univariateTheme)==="above-and-below"}const Ms=new ht({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let J={},V=class extends mt{constructor(e){super(e),this._handles=new Ie,this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new Pe,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this._handles.add([ge(this,"children","change",t=>{const{added:i,removed:s}=t,l=this._handles;i.forEach(r=>{const n=`activeLayerInfo-ready-watcher-${r.layer.uid}`;l.add(ue(r,"ready",e),n)}),s.forEach(r=>l.remove(r.layer.uid)),e()})]),this.keepCacheOnDestroy||(J={})}destroy(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(J=null)}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new Si,t.effect=e.effect,t.end(),t.scale=this.scale),t}get opacity(){var e;const t=this.layer.opacity,i=(e=this.parent)==null?void 0:e.opacity,s=this.layer.parent,l=s&&"uid"in s?this._getParentLayerOpacity(s):null;return i!=null?i*t:l!=null?l*t:t}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view&&this.view.scale}get isScaleDriven(){const e=this.layer;if(e===null)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect)||"featureReduction"in e&&e.featureReduction&&e.featureReduction.type==="cluster")return!0;if("renderer"in e&&e.renderer){if(e.renderer.type==="dot-density")return!0;const t=e.get("renderer.valueExpression");if(pe.test(t))return!0;const i=e.get("renderer.visualVariables");if(i)return i.some(s=>this._isScaleDrivenSizeVariable(s))}return this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,i=>{if(xs(i))return this._getRendererLegendElements(i.renderer,{title:i.title});if(i.featureSet&&i.featureSet.features.length){const s=i.layerDefinition,l=s&&s.drawingInfo,r=l&&ri(l.renderer),n=ws.read(s.geometryType);return r?this._getRendererLegendElements(r,{title:i.name,geometryType:n}):(H.warn("drawingInfo not available!"),null)}return null});try{const i=[];await K(t).then(s=>{s.forEach(({value:l})=>l&&i.push(...l))}),this.legendElements=i,this.notifyChange("ready")}catch(i){H.warn("error while building legend for layer!",i)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(t){H.warn("error while building legend for layer!",t)}}async buildLegendElementsForTools(){const e=this.layer;if(Es(e))this._constructLegendElementsForVoxellayer();else if(Rs(e))this._constructLegendElementsForWMTSlayer();else if($s(e))await this._constructLegendElementsForWMSSublayers();else if(nt(e))await this._constructLegendElementsForBuildingSceneLayer();else if(at(e)||Vs(e)||nt(e))await this._constructLegendElementsForSublayers();else{this._handles.remove("imageryLayers-watcher");let s="default";if(ce(e)){var t,i;const l=e;s=((l==null||(t=l.renderingRule)==null?void 0:t.functionName)||"default")+"_"+((i=e.bandIds)!=null&&i.length?e.bandIds.join(""):"###")}await this._getLegendLayers(`${e.uid}-${s}`).then(async l=>{this.legendElements=[],this.notifyChange("ready");const r=l.map(async n=>{if(ce(e)||$e(e)){const o=e.watch(["renderingRule","bandIds"],()=>ni(async()=>{J.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this._handles.add(o,"imageryLayers-watcher")}const a=this._generateSymbolTableElementForLegendLayer(n);a&&a.infos.length&&(ce(e)&&(a.title=e.title),this.legendElements.push(a)),this.notifyChange("ready")});await K(r)}).catch(l=>{H.warn("Request to server for legend has failed!",l)})}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,i=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!i&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await ai(t,"updating");const s=i?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return s.geometry=this.view.extent,(i?"queryFeatureCount"in t&&await t.queryFeatureCount(s):"queryFeatureCount"in e&&await e.queryFeatureCount(s))!==0}_getParentLayerOpacity(e){let t=1;const i=e.parent;return i&&"uid"in i&&(t=this._getParentLayerOpacity(i)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some(t=>t.ready)}_isScaleDrivenSizeVariable(e){if(e&&e.type!=="size")return!1;const t=e,i=t.minSize,s=t.maxSize;return typeof i=="object"&&i?this._isScaleDrivenSizeVariable(i):typeof s=="object"&&s?this._isScaleDrivenSizeVariable(s):!!t.expression||pe.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(i=>this._isLayerScaleDriven(i));const t=e.parent;if(e.loaded===!1&&t&&at(t)&&"source"in e&&e.source&&e.source.type==="map-layer"){for(const i of t.sourceJSON.layers)if(i.id===e.source.mapLayerId&&(i.minScale>0||i.maxScale>0))return!0}return!1}async _constructLegendElementsForVoxellayer(){this.legendElements=[],this._handles.remove("voxel-style-watcher");const e=this.layer;this._handles.add(k(e,"style",()=>this._constructLegendElementsForVoxellayer()),"voxel-style-watcher");const t=Ae(e.getVariableStyle(null)),i=[];var s;if(t){if((s=t.uniqueValues)!=null&&s.length){const n=[];t.uniqueValues.forEach(a=>{a.enabled&&n.push({label:a.label||`${a.value}`,value:a.value,symbol:new pt({color:a.color,outline:null})})}),n.length&&i.push({type:"symbol-table",title:t.label,infos:n})}else if(t.transferFunction){const{colorStops:n,stretchRange:a}=t.transferFunction,o=n.toArray().reverse(),u=a.map((h,p)=>`${p===0?ft:gt} ${gs(h)}`).reverse(),c=o.map(h=>({color:h.color,value:null,label:null}));c[0].label=u[0],c[c.length-1].label=u[1],i.push({type:"color-ramp",title:t.label,infos:c,preview:G(o.map(h=>h.color))})}}const l=e.opacity,r=i.reduce((n,a)=>n.concat(this._getAllInfos(a)),[]).filter(n=>!(n==null||!n.symbol)).map(n=>this._getSymbolPreview(n,l));await K(r),this.legendElements=i,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add(k(this.layer,"activeLayer",()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some(i=>e.styleId===i.id&&(t=i.legendUrl,!0)),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t=O(O({},e.customParameters),e.customLayerParameters)),this._handles.add(k(this.layer,"sublayers",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const i=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const s=e.toArray();for(const l of s){const r=l.watch(["title","visible","legendEnabled"],()=>this._constructLegendElementsForWMSSublayers());if(this._handles.add(r,"wms-sublayers-watcher"),!this.respectLayerVisibility||l.visible&&l.legendEnabled){const n=await this._generateSymbolTableElementForWMSSublayer(l,t);n&&n.infos.length&&i.unshift(n)}}return i}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const i=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(s=>s);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){var i;let s=e.legendUrl;if(!s)return;const l={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(s=oi(s,t));let r=null;const n=(i=e.layer)==null?void 0:i.opacity;try{r=(await tt(s,{responseType:"image"})).data,r&&(r.style.opacity=n)}catch{}return l.infos.push({src:s,preview:r,opacity:n}),l}_getLegendLayers(e,t){const i=J&&J[e];return i?Promise.resolve(i):this._legendRequest(t).then(s=>{const l=s.layers;return J[e]=l,l})}_legendRequest(e){const t=this.layer;let i={f:"json",dynamicLayers:e};if(ce(t)){const l=t.exportImageServiceParameters.renderingRule;if(l&&(i.renderingRule=JSON.stringify(l.rasterFunctionDefinition||l.toJSON())),t.bandIds&&(i.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:r,viewId:n,customParameters:a}=t;i=O(O({raster:r,viewId:n},i),a)}}let s=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const l=s.indexOf("?");l>-1?s=s.substring(0,l)+"/legend"+s.substring(l):s+="/legend"}else{const l=s.toLowerCase().indexOf("/rest/"),r=s.substring(0,l)+s.substring(l+5,s.length);s=bs+"?soapUrl="+encodeURI(r)+"&returnbytes=true"}return tt(s,{query:i}).then(l=>l.data)}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(k(e,"sublayers",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){H.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForBuildingSublayers(e,t){let i=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const s=e.toArray();for(const l of s){const r=l.watch(["renderer","opacity","title","visible"],()=>this._constructLegendElementsForBuildingSceneLayer());if(this._handles.add(r,"sublayers-watcher"),!this.respectLayerVisibility||l.visible){const n=l&&l.opacity!=null?l.opacity:null,a=n!=null?n*t:t;if(l.type==="building-group"){const o={type:"symbol-table",title:l.title,infos:[]},u=await this._generateLegendElementsForBuildingSublayers(l.sublayers,a);o.infos.push(...u),i=[o,...i]}else l.renderer&&(i=[...await this._getRendererLegendElements(l.renderer,{title:l.title,opacity:a,sublayer:l}),...i])}}return i.filter(l=>!!l&&(!("infos"in l)||l.infos.length>0))}async _constructLegendElementsForSublayers(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(k(e,"sublayers",()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){H.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForSublayers(e,t,i){const s=this.layer;let l=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let r=e.toArray();!i&&this.sublayerIds&&this.sublayerIds.length&&(r=this.sublayerIds.map(n=>s.findSublayerById(n)).filter(Boolean));for(const n of r){const a=n.watch("renderer, opacity, title, visible, legendEnabled",()=>this._constructLegendElementsForSublayers());if(this._handles.add(a,"sublayers-watcher"),!this.respectLayerVisibility||n.visible&&n.legendEnabled&&this._isSublayerInScale(n)){const o=n&&n.opacity!=null?n.opacity:null,u=o!=null?o*t:t;if(n.renderer&&!n.sublayers&&n.originIdOf("renderer")>oe.SERVICE)await n.load(),l=[...await this._getRendererLegendElements(n.renderer,{title:n.title,opacity:u,sublayer:n}),...l];else{const c=await this._generateSymbolTableElementForSublayer(n,u,i);c&&l.unshift(c)}}}return l.filter(n=>!!n&&(!("infos"in n)||n.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,i){if(!i){i=new Map;const l=this.layer,r=e.source;let n=null;if(!(!r||r.type==="map-layer"&&r.mapLayerId===e.id&&(!r.gdbVersion||r.gdbVersion===("gdbVersion"in l&&l.gdbVersion)))||e.originIdOf("renderer")>oe.SERVICE||e.originIdOf("labelingInfo")>oe.SERVICE||e.originIdOf("labelsVisible")>oe.SERVICE){const o=new Ii({layer:this.layer});n=o.hasDynamicLayers?o.dynamicLayers:null,o.destroy()}const a=n||`${l.uid}-default`;(await this._getLegendLayers(a,n)).forEach(o=>i.set(o.layerId,o))}const s=i.get(e.id);if((!s||s!=null&&s.subLayerIds&&s.defaultVisibility)&&e.sublayers){const l=await this._generateLegendElementsForSublayers(e.sublayers,t,i);return{type:"symbol-table",title:e.title,infos:l}}return this._generateSymbolTableElementForLegendLayer(s,e,t)}_generateSymbolTableElementForLegendLayer(e,t,i){var s;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const l=t==null?void 0:t.renderer;let r=(t==null?void 0:t.title)||e.layerName;if(l&&(!t||(t==null?void 0:t.originIdOf("renderer"))>oe.SERVICE)){const o=(t==null?void 0:t.title)||this._getRendererTitle(l,t);o&&(r&&typeof o!="string"&&"title"in o&&(o.title=r),r=o)}const n={type:"symbol-table",title:r,legendType:e.legendType?e.legendType:null,infos:[]},a=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return((s=e.legendGroups)==null?void 0:s.length)>0?e.legendGroups.forEach(o=>{var u;const c={type:"symbol-table",title:o.heading,legendType:e.legendType?e.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(a.filter(h=>h.groupId===o.id),e.layerId,i)};((u=c.infos)==null?void 0:u.length)>0&&n.infos.push(c)}):n.infos=this._generateSymbolTableElementInfosForLegendLayer(a,e.layerId,i),n.infos.length>0?n:null}_generateSymbolTableElementInfosForLegendLayer(e,t,i){return e.map(s=>{let l=s.url;if(s.imageData&&s.imageData.length>0)l=`data:image/png;base64,${s.imageData}`;else{if(l.indexOf("http")===0)return null;l=ci(`${this.layer.url}/${t}/images/${l}`)}return{label:s.label,src:l,opacity:i==null?this.opacity:i,width:s.width,height:s.height}}).filter(s=>!!s)}_isSublayerInScale(e){const t=e.minScale||0,i=e.maxScale||0;return!(t>0&&t<this.scale||i>this.scale)}_isLegendLayerInScale(e,t){const i=t||this.layer;let s=null,l=null,r=!0;return!i.minScale&&i.minScale!==0||!i.maxScale&&i.maxScale!==0?(e.minScale===0&&i.tileInfo&&(s=i.tileInfo.lods[0].scale),e.maxScale===0&&i.tileInfo&&(l=i.tileInfo.lods[i.tileInfo.lods.length-1].scale)):(s=Math.min(i.minScale,e.minScale)||i.minScale||e.minScale,l=Math.max(i.maxScale,e.maxScale)),(s>0&&s<this.scale||l>this.scale)&&(r=!1),r}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&this.layer.version<10.1||e.length===0)return e;const i=t.renderer,s=e.some(n=>n.values);let l=null,r=null;return s&&e.some((n,a)=>(n.values||(l=a,r=n,r.label||(r.label="others")),r!=null)),i?i.type==="unique-value"?r&&(e.splice(l,1),e.push(r)):i.type==="class-breaks"&&(r&&e.splice(l,1),e.reverse(),r&&e.push(r)):r&&(e.splice(l,1),e.push(r)),e}async _getRendererLegendElements(e,t={}){return As(e,this.view)?Is(e)?this._constructPointCloudRendererLegendElements(e,t):Tt(e)?this._constructDotDensityRendererLegendElements(e):this._constructRendererLegendElements(e,t):(H.warn(`Renderer of type '${e.type}' not supported!`),[])}_getPointCloudRendererTitle(e){return e.legendOptions&&e.legendOptions.title||e.field}_constructPointCloudRendererLegendElements(e,t={}){const i=t.title,s=[];let l=null,r=null;if(Ue(e))l={type:"symbol-table",title:i||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(a=>{l.infos.unshift({label:a.label||a.minValue+" - "+a.maxValue,value:[a.minValue,a.maxValue],symbol:this._getAppliedCloneSymbol(me,a.color)})});else if(We(e)){const a=e.stops;let o=null;if(a.length&&(a.length===1&&(o=a[0].color),!o)){const c=a[0].value,h=a[a.length-1].value;c!=null&&h!=null&&(o=Lt(c+(h-c)/2,a))}l={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(me,o||me.color)}]};const u=Gi(e.stops);r={type:"color-ramp",title:i||this._getPointCloudRendererTitle(e),infos:u,preview:G(u.map(c=>c.color))}}else je(e)&&(l={type:"symbol-table",title:i||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach(a=>{l.infos.push({label:a.label||a.values.join(", "),value:a.values.join(", "),symbol:this._getAppliedCloneSymbol(me,a.color)})}));l&&l.infos.length&&s.push(l),r&&r.infos.length&&s.push(r);const n=s.reduce((a,o)=>a.concat(o.infos),[]).filter(a=>!!a.symbol).map(a=>this._getSymbolPreview(a,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}}));return K(n).then(()=>s)}_getElementInfoForDotDensity(e,t){const{backgroundColor:i,outline:s,dotSize:l}=e,r=this.effectList,n=r==null?void 0:r.effects.map(f=>f.toJSON()),a=di(n),o=l+"-"+t+"-"+i+"-"+(s&&JSON.stringify(s.toJSON()))+"-"+a,u=this._dotDensityUrlCache,c=u.has(o)?u.get(o):ui(e,t);u.set(o,c);const h={shape:{type:"image",x:0,y:0,width:c.width,height:c.height,src:c.src},fill:null,stroke:null,offset:[0,0]},p=Ai([[h]],[c.width,c.height],{effectView:this.effectList});return{opacity:1,src:c.src,preview:p,width:c.width,height:c.height}}_constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),i=e.legendOptions&&e.legendOptions.unit,s={type:"symbol-table",title:{value:t&&Math.round(t),unit:i||""},infos:[]};return e.attributes.forEach(l=>{const r=this._getElementInfoForDotDensity(e,l.color);r.label=l.label||l.valueExpressionTitle||l.field,s.infos.push(r)}),Promise.resolve([s])}async _constructRendererLegendElements(e,t={}){const{title:i,sublayer:s}=t,l=s||this.layer;let r=await this._loadRenderer(e);this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const n=await this._getVisualVariableLegendElements(r,l)||[],a={type:"symbol-table",title:i||this._getRendererTitle(r,l),infos:[]};let o=null,u=!1;const c=new Set;if(Be(r)&&!this._hasSizeRamp){const y=await vt(r);a.infos.push({label:null,symbol:y})}else if(ks(r)){let y=i;const w=Fs(r)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",g=n.findIndex(T=>T.type==="color-ramp"),C=g!==-1?n.splice(g,1)[0]:null,S=n.findIndex(T=>T.type==="size-ramp"),A=S!==-1?n.splice(S,1)[0]:null,$=[];C&&(y=C.title,$.push(C)),A&&(y=A.title,$.push(A)),$.length>0&&n.push({type:w,title:y,infos:$})}else if(zt(r)){const y=Ji(r);n.push({type:"heatmap-ramp",title:i,infos:y,preview:G(y.map(w=>w.color),{effectList:this.effectList})})}else if(Ne(r)){const y=r&&r.authoringInfo;if(y&&y.type==="relationship"){const{focus:w,numClasses:g,field1:C,field2:S}=y;if(g&&C&&S){const A=[C,S];let $=wt(w)||0;for(const W of A){const{field:N,normalizationField:R,label:q}=W,D=q||{field:this._getFieldAlias(N,l),normField:R&&this._getFieldAlias(R,l)},ae=Ms.clone();ae.angle=$,a.infos.push({label:D,symbol:ae}),c.add(ae),$+=90}const T=es({focus:w,numClasses:g,infos:r.uniqueValueInfos});n.unshift(T)}}else{const w=r.field;r.uniqueValueInfos.forEach(g=>{g.symbol&&a.infos.push({label:g.label||this._getDomainName(w,g.value,l)||g.value,value:g.value,symbol:g.symbol})})}r.defaultSymbol&&(a.infos.push({label:r.defaultLabel||"others",symbol:r.defaultSymbol}),u=!0)}else if(ie(r))o=this._isUnclassedRenderer(r),(!o||!this._hasSizeRamp)&&(r.classBreakInfos.forEach(y=>{y.symbol&&a.infos.unshift({label:y.label||(o?null:y.minValue+" - "+y.maxValue),value:[y.minValue,y.maxValue],symbol:y.symbol})}),o&&(a.title=null),this._updateInfosforClassedSizeRenderer(r,a.infos)),r.defaultSymbol&&!o&&(a.infos.push({label:r.defaultLabel||"others",symbol:r.defaultSymbol}),u=!0);else if(Vt(r))if($e(this.layer)||zs(this.layer)){const y=this._constructTileImageryStretchRendererElements(r);Ts(y)?n.push(y):a.infos=y}else{const y=this.layer;let w,g;r.statistics&&r.statistics.length&&(w=r.statistics[0].min!=null?r.statistics[0].min:r.statistics[0][0],g=r.statistics[0].max!=null?r.statistics[0].max:r.statistics[0][1]);let C=[];const S=Ae(y.renderingRule?await y.generateRasterInfo(y.renderingRule):y.serviceRasterInfo),A=S.keyProperties.BandProperties,$=rt[y.rasterInfo.pixelType.toLowerCase()];S.bandCount===1||y.bandIds&&y.bandIds.length===1?(w=w!=null?w:S.statistics?S.statistics[y.bandIds[0]].min:$[0],g=g!=null?g:S.statistics?S.statistics[y.bandIds[0]].max:$[1],w||g?n.push(this._getStretchLegendElements(r,{min:w,max:g})):this._getServerSideLegend()):S.bandCount>=3?A&&A.length>=S.bandCount?y.bandIds&&y.bandIds.length===3?(C=y.bandIds.map(T=>A[T].BandName),a.infos=this._createSymbolTableElementMultiBand(C)):y.format==="lerc"?(C=[0,1,2].map(T=>A[T].BandName),a.infos=this._createSymbolTableElementMultiBand(C)):this._getServerSideLegend():y.format==="lerc"?(C=["band1","band2","band3"],a.infos=this._createSymbolTableElementMultiBand(C)):this._getServerSideLegend():this._getServerSideLegend()}else if(Rt(r))r.colormapInfos.forEach(y=>{a.infos.push({label:y.label,value:y.value,symbol:this._getAppliedCloneSymbol(Ss,y.color)})});else if(te(r)){let y=r.symbol;switch(t.geometryType){case"point":y="pointSymbol"in l&&l.pointSymbol;break;case"polyline":y="lineSymbol"in l&&l.lineSymbol;break;case"polygon":y="polygonSymbol"in l&&l.polygonSymbol}r.symbol&&!this._hasSizeRamp&&a.infos.push({label:r.label,symbol:y})}else if($t(r)){r.outputUnit&&(this.title="("+r.toJSON().outputUnit+")"),a.title=r.attributeField;const y=r.getClassBreakInfos();y!=null&&y.length?y.forEach(w=>{a.infos.push({label:w.minValue+" - "+w.maxValue,symbol:w.symbol})}):a.infos.push({label:r.attributeField,symbol:r.getDefaultSymbol()})}else xt(r)&&n.push(this._getStretchLegendElements(r,{min:0,max:255}));const h=r.defaultSymbol;!h||u||te(r)||o&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||n.push({type:"symbol-table",infos:[{label:r.defaultLabel||"others",symbol:h}]}),a.infos.length&&n.unshift(a);const p=t.opacity==null?this.opacity:t.opacity,f=this._isTallSymbol("visualVariables"in r&&r.visualVariables),m=ce(this.layer)||$e(this.layer),_=n.reduce((y,w)=>y.concat(this._getAllInfos(w)),[]).filter(y=>!(y==null||!y.symbol)).map(y=>this._getSymbolPreview(y,p,{isDefault:y.symbol===h,applyScaleDrivenSize:!c.has(y.symbol),symbolConfig:{isTall:f,isSquareFill:m},effectList:c.has(y.symbol)?null:this.effectList}));return r=null,await K(_),n}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){const t=e==null?void 0:e.infos;return t?t.reduce((i,s)=>i.concat(this._getAllInfos(s)),[]):[e]}_constructTileImageryStretchRendererElements(e){var t,i;const s=this.layer,l=s.rasterInfo,r=l.bandCount||e.statistics.length;let n,a,o=[];const u=l.keyProperties&&l.keyProperties.BandProperties,c=e!=null&&(t=e.statistics)!=null&&t.length?e.statistics:l==null?void 0:l.statistics;if(c)n=c[0].min!==void 0?c[0].min:c[0][0],a=c[0].max||c[0][1];else{const p=rt[s.rasterInfo.pixelType.toLowerCase()];n=p[0],a=p[1]}if(s.hasStandardTime()&&(n=s.getStandardTimeValue(n),a=s.getStandardTimeValue(a)),l.bandCount===1||((i=s.bandIds)==null?void 0:i.length)===1)return this._getStretchLegendElements(e,{min:n,max:a});function h(p){var f;const m=(s!=null&&(f=s.bandIds)!=null&&f.length?s.bandIds:Array.from(Array(Math.min(l.bandCount,3)).keys())).map(_=>p&&p[_]&&p[_].BandName||"band"+(_+1));return m.length<3?m.push(m[1]):m.length>3&&m.splice(3),m}return o=u&&u.length>=r?h(u):h(),this._createSymbolTableElementMultiBand(o)}_getStretchLegendElements(e,t){const i=e.colorRamp,s=Ki(i,t);return{type:"stretch-ramp",title:"",infos:s,preview:G(s.map(l=>l.color))}}async _getSizeLegendElement(e,t,i,s){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await os(i,t,await ke(i),this.scale,this.view.type,s)}}_createSymbolTableElementMultiBand(e){const t=[],i=["red","green","blue"];return e.forEach((s,l)=>{t.push({label:{colorName:i[l],bandName:s},src:Ui[l],opacity:1})}),t}_updateInfosforClassedSizeRenderer(e,t){const i=e.authoringInfo&&e.authoringInfo.type==="class-breaks-size",s=e.classBreakInfos.some(l=>qe(l.symbol));if(i&&s){const l=Fe,r=Me,n=e.classBreakInfos.length,a=(l-r)/(n>1?n-1:n);t.forEach((o,u)=>{o.size=l-a*u})}}_isTallSymbol(e){let t=!1,i=!1;if(e)for(let s=0;s<e.length&&(!t||!i);s++){const l=e[s];l.type==="size"&&(l.axis==="height"&&(t=!0),l.axis==="width-and-depth"&&(i=!0))}return t&&i}async _getSymbolPreview(e,t,i){let s=i!=null&&i.isDefault||e.size!=null||!this._hasSizeRamp?e.size:yi(hi.size);if(this._scaleDrivenSizeVariable&&i!=null&&i.applyScaleDrivenSize){const{getSize:l}=await import("./vendor.1dc52be5.js").then(function(r){return r.xo});s=l(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type==="simple-marker"?e.symbol.style:null})}return pi(e.symbol,{size:s,opacity:t,scale:!1,symbolConfig:i==null?void 0:i.symbolConfig,effectView:i==null?void 0:i.effectList}).then(l=>(e.preview=l,e)).catch(()=>(e.preview=null,e))}async _loadRenderer(e){var t,i;const s=[],l=this.layer;e=e.clone(),this._hasClusterSizeVariable=!1;const r="visualVariables"in e&&((t=e.visualVariables)==null?void 0:t.some(a=>a.type==="size"&&a.target!=="outline"&&!pe.test(a.valueExpression)));if(e&&"visualVariables"in e&&!r&&"featureReduction"in l&&((i=l.featureReduction)==null?void 0:i.type)==="cluster"){const a=this.layerView._effectiveRenderer,o=Ae(Mi(a,this.view));if(o){const u=l.featureReduction;if("clusterMinSize"in u&&"clusterMaxSize"in u){const{clusterMinSize:h,clusterMaxSize:p}=u;o.legendOptions=new mi({showLegend:h!==p})}const c=e.visualVariables||[];e.visualVariables=c.concat([o]),this._hasClusterSizeVariable=!0}}const n=await ke(e);if(ie(e)||Ne(e)){const a=(e.classBreakInfos||e.uniqueValueInfos).map(o=>this._fetchSymbol(o.symbol,n).then(u=>{o.symbol=u}).catch(()=>{o.symbol=null}));Array.prototype.push.apply(s,a)}return s.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:n).then(a=>{this._applySymbolToRenderer(e,a,te(e))}).catch(()=>{this._applySymbolToRenderer(e,null,te(e))})),K(s).then(()=>e)}_applySymbolToRenderer(e,t,i){i?e.symbol=t:e.defaultSymbol=t}_fetchSymbol(e,t){if(!e)return Promise.reject();if(e.type==="web-style"){const i=e.portal,s=i&&i.url,l=i&&i.user&&i.user.username,r=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+s+"-"+l,n=this._webStyleSymbolCache;return n.has(r)||(this.view.type==="2d"?n.set(r,e.fetchCIMSymbol()):n.set(r,e.fetchSymbol())),n.get(r).then(a=>this._getAppliedCloneSymbol(a,t)).catch(()=>(H.warn("Fetching web-style failed!"),Promise.reject()))}return Promise.resolve(this._getAppliedCloneSymbol(e,t))}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const i=e.clone(),s=t&&t.toRgba();return i.type.indexOf("3d")>-1?this._applyColorTo3dSymbol(i,s):i.type==="cim"?ut(i,t):i.color&&(i.color=new F(s||i.color)),i}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(i=>{i&&(i.material||(i.material={}),i.material.color=new F(t))})}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||e.type==="vector-field")return null;const i=e.visualVariables,s=[],l=[],r=[];for(const c of i)c.type==="color"?s.push(c):c.type==="size"?l.push(c):c.type==="opacity"&&r.push(c);const n=[...s,...l,...r];let a,o;if(s.length===0&&ie(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){const c=e.classBreakInfos[0];a=c&&c.symbol}if(s.length===0&&te(e)&&(a=e.symbol),a)if(a.type.indexOf("3d")>-1){const c=a.symbolLayers.getItemAt(0);c.type==="water"?Ee(c.color)&&(o=c.color):Ee(c.material)&&Ee(c.material.color)&&(o=c.material.color)}else a.url||(o=a.color);const u=this.effectList;return(await Promise.all(n.map(async c=>{if(!c.legendOptions||c.legendOptions.showLegend!==!1){const h=Be(e)?c.field:this._getRampTitle(c,t);let p=null;const f="getField"in t&&t.getField&&t.getField(c.field),m=f&&fi(f);if(c.type==="color"){const _=await st(c,null,m);p={type:"color-ramp",title:h,infos:_,preview:G(_.map(y=>y.color),{effectList:u})},this._hasColorRamp||(this._hasColorRamp=!(p.infos==null||!p.infos.length))}else if(c.type==="size"&&c.target!=="outline")pe.test(c.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=c):(p=await this._getSizeLegendElement(h,c,e,m),this._hasSizeRamp||(this._hasSizeRamp=!(p.infos==null||!p.infos.length)));else if(c.type==="opacity"){const _=await st(c,o,m);p={type:"opacity-ramp",title:h,infos:_,preview:G(_.map(y=>y.color),{effectList:u})},this._hasOpacityRamp||(this._hasOpacityRamp=!(p.infos==null||!p.infos.length))}return p&&p.infos?p:null}}))).filter(c=>!!c)}_getDomainName(e,t,i){if(e&&typeof e!="function"){const s="getField"in i&&i.getField&&i.getField(e),l=s&&"getFieldDomain"in i&&i.getFieldDomain?i.getFieldDomain(s.name):null;return l&&l.type==="coded-value"?l.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,i=e.field;if("featureReduction"in t&&t.featureReduction&&t.featureReduction.type==="cluster"){const s=t.featureReduction,l="popupTemplate"in s&&s.popupTemplate,r=l&&l.fieldInfos;if(r){for(const n of r)if(n.fieldName===i)return i==="cluster_count"?n.label||{showCount:!0}:n.label}}return{showCount:!0}}_getRampTitle(e,t){let i=e.field,s=e.normalizationField,l=!1,r=!1,n=!1,a=null;i=typeof i=="function"?null:i,s=typeof s=="function"?null:s;const o=e.legendOptions&&e.legendOptions.title;if(o!=null)a=o;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const u=t.renderer.authoringInfo.visualVariables;for(let c=0;c<u.length;c++){const h=u[c];if(h.type==="color"){if(h.style==="ratio"){l=!0;break}if(h.style==="percent"){r=!0;break}if(h.style==="percent-of-total"){n=!0;break}}}}a={field:i&&this._getFieldAlias(i,t),normField:s&&this._getFieldAlias(s,t),ratio:l,ratioPercent:r,ratioPercentTotal:n}}return a}_getRendererTitle(e,t){const i=e;if(i.legendOptions&&i.legendOptions.title)return i.legendOptions.title;if(i.valueExpressionTitle)return i.valueExpressionTitle;let s=i.field,l=null,r=null;ie(i)&&(l=i.normalizationField,r=i.normalizationType==="percent-of-total"),s=typeof s=="function"?null:s,l=typeof l=="function"?null:l;let n=null;return(s||l)&&(n={field:s&&this._getFieldAlias(s,t),normField:l&&this._getFieldAlias(l,t),normByPct:r}),n}_getFieldAlias(e,t){const i="popupTemplate"in t&&t.popupTemplate,s=i&&i.fieldInfos;let l=null;s&&s.some(o=>e===o.fieldName&&(l=o,!0));let r=null;"getField"in t&&t.getField?r=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(r=t.fieldsIndex.get(e));const n=l||r;let a=null;return n&&(a=l&&l.label||r&&r.alias||"name"in n&&n.name||"fieldName"in n&&n.fieldName),a}_isUnclassedRenderer(e){const t=e.visualVariables;let i=!1;return ie(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&t&&(i=e.field?t.some(s=>!(!s||e.field!==s.field||(e.normalizationField||s.normalizationField)&&e.normalizationField!==s.normalizationField)):!!t.length),i}};v([I()],V.prototype,"children",void 0),v([I({readOnly:!0})],V.prototype,"effectList",null),v([I()],V.prototype,"layerView",void 0),v([I()],V.prototype,"layer",void 0),v([I()],V.prototype,"legendElements",void 0),v([I({readOnly:!0})],V.prototype,"opacity",null),v([I()],V.prototype,"parent",void 0),v([I({readOnly:!0,dependsOn:[]})],V.prototype,"ready",null),v([I()],V.prototype,"hideLayersNotInCurrentView",void 0),v([I()],V.prototype,"keepCacheOnDestroy",void 0),v([I()],V.prototype,"respectLayerVisibility",void 0),v([I({readOnly:!0})],V.prototype,"scale",null),v([I()],V.prototype,"sublayerIds",void 0),v([I({readOnly:!0})],V.prototype,"isScaleDriven",null),v([I()],V.prototype,"title",void 0),v([I({readOnly:!0,dependsOn:["ready"],value:0})],V.prototype,"version",null),v([I()],V.prototype,"view",void 0),V=v([ye("esri.widgets.Legend.support.ActiveLayerInfo")],V);const kt=V,j={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},Ft=Pe.ofType(kt),Bs=["esri.layers.BuildingSceneLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer"],Mt="view.basemapView.baseLayerViews",Bt="view.groundView.layerViews",Nt="view.basemapView.referenceLayerViews",Ns=[Mt,Bt,"view.layerViews",Nt];let M=class extends mt{constructor(e){super(e),this._handles=new Ie,this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new Pe,this.activeLayerInfos=new Ft,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this._handles.add(ue(this,"view",this._viewHandles),j.view),this._handles.add(gi(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this._handles.destroy(),this._handles=null,this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}_viewHandles(){this._handles.remove(j.state),this.view&&this._handles.add(ue(this,"state",this._stateHandles),j.state)}_stateHandles(){this._resetAll(),this.state==="ready"&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this._handles.remove([j.allLayerViews,j.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this._handles.remove(e);const t=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],t&&t.parent&&t.parent.children.remove(t)}_watchPropertiesAndAllLayerViews(){const{allLayerViews:e}=this.view;e.length&&this._refresh(),this._handles.add(e.on("change",this._allLayerViewsChangeHandle.bind(this)),j.allLayerViews),this._handles.add(k(this,"layerInfos, basemapLegendVisible, groundLegendVisible",this._propertiesChangeHandle.bind(this)),j.legendProperties)}_allLayerViewsChangeHandle(e){e.removed.forEach(t=>this._destroyViewActiveLayerInfo(t.uid)),this._refresh()}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){if(e.length<2)return;const t=[];e.forEach(s=>{if(!s.parent){const l=s.layer.parent,r=l&&"uid"in l&&this._layerViewByLayerId[l.uid],n=r&&this._activeLayerInfosByLayerViewId[r.uid];n&&e.indexOf(n)!==-1&&(t.push(s),s.parent=n,n.children.add(s),this._sortActiveLayerInfos(n.children))}}),e.removeMany(t);const i={};this.view.allLayerViews.forEach((s,l)=>i[s.layer.uid]=l),e.sort((s,l)=>{const r=i[s.layer.uid]||0;return(i[l.layer.uid]||0)-r})}_generateLayerViews(){const e=[];return Ns.filter(this._filterLayerViews,this).map(this.get,this).filter(t=>t!=null).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const t=!this.basemapLegendVisible&&(e===Mt||e===Nt),i=!this.groundLegendVisible&&e===Bt;return!t&&!i}_collectLayerViews(e,t){const i=s=>(s&&s.forEach(l=>{t.push(l),i(l[e])}),t);return i}_filterLayerViewsByLayerInfos(e){const t=this.layerInfos;return!t||!t.length||t.some(i=>this._hasLayerInfo(i,e))}_hasLayerInfo(e,t){const i=this._isLayerUIDMatching(e.layer,t.layer.uid);return i&&(this._layerInfosByLayerViewId[t.uid]=e),i}_isLayerUIDMatching(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))}_hasLayerUID(e,t){return e&&e.some(i=>this._isLayerUIDMatching(i,t))}_isLayerViewSupported(e){return!!Bs.includes(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this._handles.remove(e.uid),this._handles.add(k(e,"legendEnabled, layer.legendEnabled",()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this._handles.remove(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.get("layer.legendEnabled")}_buildActiveLayerInfo(e){var t;const i=e.layer,s=e.uid,l=this._layerInfosByLayerViewId[s];let r=this._activeLayerInfosByLayerViewId[s];if(!r){const a=l&&l.title!==void 0&&l.layer.uid===i.uid;r=new kt({layer:i,layerView:e,title:a?l.title:i.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:l&&l.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[s]=r}const n=i.parent&&"uid"in i.parent&&this._layerViewByLayerId[(t=i.parent)==null?void 0:t.uid];if(r.parent=this._activeLayerInfosByLayerViewId[n==null?void 0:n.uid],!this._handles.has(s)){const a=[k(i,"title",o=>this._titleHandle(o,r)),k(i,"renderer?, opacity, pointSymbol?, lineSymbol?, polygonSymbol?",()=>this._constructLegendElements(r)),bi(this.view,"stationary",()=>this._scaleHandle(r)),k(e,"_effectiveRenderer",()=>this._constructLegendElements(r)),k(i,"effect",()=>this._constructLegendElements(r))];if(this.respectLayerVisibility){const o=k(e,"legendEnabled",c=>this._legendEnabledHandle(c,r)),u=k(i,"legendEnabled",c=>this._legendEnabledHandle(c,r));a.push(o,u)}this._handles.add(a,s)}r.isScaleDriven||this._constructLegendElements(r),this._addActiveLayerInfo(r)}_titleHandle(e,t){t.title=e,this._constructLegendElements(t)}_legendEnabledHandle(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){const{layerView:t,layer:i}=e;if(this._isLayerActive(t)&&this.activeLayerInfos.indexOf(e)===-1){const l=e.parent;if(l)l.children.indexOf(e)===-1&&l.children.push(e),this._sortActiveLayerInfos(l.children);else{var s;const r=(s=this.layerInfos)==null?void 0:s.some(n=>n.layer.uid===i.uid);i.parent&&"uid"in i.parent&&!r?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const r=[];this._activeLayerInfosWithNoParent.forEach(n=>{const a=n.layer.parent,o=a&&"uid"in a&&this._layerViewByLayerId[a==null?void 0:a.uid],u=this._activeLayerInfosByLayerViewId[o==null?void 0:o.uid];u&&(r.push(n),n.parent=u)}),r.length&&(this._activeLayerInfosWithNoParent.removeMany(r),r.forEach(n=>this._addActiveLayerInfo(n)))}}}_removeActiveLayerInfo(e){const t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){const t=e.layer;"featureCollections"in t&&t.featureCollections?e.buildLegendElementsForFeatureCollections(t.featureCollections):"renderer"in t&&t.renderer?e.buildLegendElementsForRenderer(t.renderer):"url"in t&&t.url?e.buildLegendElementsForTools():e.children.forEach(i=>this._constructLegendElements(i))}};v([I({type:Ft})],M.prototype,"activeLayerInfos",void 0),v([I()],M.prototype,"basemapLegendVisible",void 0),v([I()],M.prototype,"groundLegendVisible",void 0),v([I()],M.prototype,"hideLayersNotInCurrentView",void 0),v([I()],M.prototype,"keepCacheOnDestroy",void 0),v([I()],M.prototype,"respectLayerVisibility",void 0),v([I()],M.prototype,"layerInfos",void 0),v([I({readOnly:!0})],M.prototype,"state",null),v([I()],M.prototype,"view",void 0),M=v([ye("esri.widgets.Legend.LegendViewModel")],M);const Os=M,Ds="http://www.w3.org/2000/svg",E={diamondContainer:"esri-relationship-ramp--diamond__container",diamondLeftCol:"esri-relationship-ramp--diamond__left-column",diamondRightCol:"esri-relationship-ramp--diamond__right-column",diamondMidCol:"esri-relationship-ramp--diamond__middle-column",diamondMidColLabel:"esri-relationship-ramp--diamond__middle-column--label",diamondMidColRamp:"esri-relationship-ramp--diamond__middle-column--ramp",squareTable:"esri-relationship-ramp--square__table",squareTableRow:"esri-relationship-ramp--square__table-row",squareTableCell:"esri-relationship-ramp--square__table-cell",squareTableLabel:"esri-relationship-ramp--square__table-label",squareTableLabelLeftBottom:"esri-relationship-ramp--square__table-label--left-bottom",squareTableLabelRightBottom:"esri-relationship-ramp--square__table-label--right-bottom",squareTableLabelLeftTop:"esri-relationship-ramp--square__table-label--left-top",squareTableLabelRightTop:"esri-relationship-ramp--square__table-label--right-top"};function Ot(e,t,i,s){const{focus:l,labels:r}=e,n=!!l,a=qs(e,t,i,s),o={justifyContent:"center"},u=xe();return n?d("div",{class:E.diamondContainer,styles:o},d("div",{class:E.diamondLeftCol},u?r.right:r.left),d("div",{class:E.diamondMidCol},d("div",{class:E.diamondMidColLabel},r.top),a,d("div",{class:E.diamondMidColLabel},r.bottom)),d("div",{class:E.diamondRightCol},u?r.left:r.right)):d("div",{class:E.squareTable},d("div",{class:E.squareTableRow},d("div",{class:he(E.squareTableCell,E.squareTableLabel,E.squareTableLabelRightBottom)},u?r.top:r.left),d("div",{class:E.squareTableCell}),d("div",{class:he(E.squareTableCell,E.squareTableLabel,E.squareTableLabelLeftBottom)},u?r.left:r.top)),d("div",{class:E.squareTableRow},d("div",{class:E.squareTableCell}),a,d("div",{class:E.squareTableCell})),d("div",{class:E.squareTableRow},d("div",{class:he(E.squareTableCell,E.squareTableLabel,E.squareTableLabelRightTop)},u?r.right:r.bottom),d("div",{class:E.squareTableCell}),d("div",{class:he(E.squareTableCell,E.squareTableLabel,E.squareTableLabelLeftTop)},u?r.bottom:r.right)))}function ot(e,t,i){const s=`${i}_arrowStart`,l=`${i}_arrowEnd`,r=e==="left",n={markerStart:null,markerEnd:null};switch(t){case"HL":r?n.markerStart=`url(#${l})`:n.markerEnd=`url(#${s})`;break;case"LL":n.markerStart=`url(#${l})`;break;case"LH":r?n.markerEnd=`url(#${s})`:n.markerStart=`url(#${l})`;break;default:n.markerEnd=`url(#${s})`}return n}function qs(e,t,i,s,l=60){const{focus:r,numClasses:n,colors:a,rotation:o}=e,u=!!r,c=Math.sqrt(l**2+l**2)+(u?0:5),h=[],p=[],f=[],m=(l||75)/n;for(let R=0;R<n;R++){const q=R*m;for(let D=0;D<n;D++){const ae=D*m,Je=Ei(a[R][D]),jt=$i(null),Xe={type:"rect",x:ae,y:q,width:m,height:m};h.push(Ri(Je)),p.push(Vi(Xe,Je.fill,jt,null)),f.push(xi(Xe))}}const _=10,y=15,w=15,g=10;let C=null;u||(C="margin: -15px -15px -18px -15px");const S=ot("left",r,t),A=ot("right",r,t),$=zi(f),T=it($,c,c,0,!1,o,!1),W=it($,c,c,0,!1,u?-45:null,!1),N={filter:ze(s),opacity:i==null?null:`${i}`};return d("div",{styles:N,class:u?E.diamondMidColRamp:E.squareTableCell},d("svg",{xmlns:Ds,width:c,height:c,style:C},d("defs",null,d("marker",{id:`${t}_arrowStart`,markerWidth:"10",markerHeight:"10",refX:"5",refY:"5",markerUnits:"strokeWidth",orient:"auto"},d("polyline",{points:"0,0 5,5 0,10",fill:"none",stroke:"#555555","stroke-width":"1"})),d("marker",{id:`${t}_arrowEnd`,markerWidth:"10",markerHeight:"10",refX:"0",refY:"5",markerUnits:"strokeWidth",orient:"auto"},d("polyline",{points:"5,0 0,5 5,10",fill:"none",stroke:"#555555","stroke-width":"1"})),h),d("g",{transform:T},p),d("g",{transform:W},d("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":S.markerStart,"marker-end":S.markerEnd,x1:-_,y1:l-y,x2:-_,y2:y}),d("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":A.markerStart,"marker-end":A.markerEnd,x1:w,y1:l+g,x2:l-w,y2:l+g}))))}const Ps=vi(),Dt=10,Ge=20,Ce=10,Qe=20,Ke={univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",colorRamp:"esri-legend__color-ramp"};function Hs(e="vertical"){const t="stroke:rgb(200, 200, 200);stroke-width:1";return e==="vertical"?d("svg",{height:"4",width:"10"},d("line",{x1:"0",y1:"2",x2:"10",y2:"2",style:t})):d("svg",{height:"10",width:"10"},d("line",{x1:"5",y1:"0",x2:"5",y2:"10",style:t}))}function Us(e,t="vertical"){const i=document.createElement("div");return i.style.height=`${Ge}px`,i.className=Ke.univariateAboveAndBelowSymbol,e!=null&&(i.style.opacity=e.toString()),Ps.append(i,Hs.bind(null,t)),i}function qt(e,t,i="vertical",s){e.infos.forEach((l,r)=>{if(s&&r===2)l.preview=Us(t,i);else{const n=U(l.size)+(i==="horizontal"?Qe:Ce),a=l.preview.tagName.toLowerCase()==="div",o=a?l.preview:document.createElement("div");o.className=Ke.univariateAboveAndBelowSymbol,i==="horizontal"?o.style.width=`${n}px`:o.style.height=`${n}px`,a||o.appendChild(l.preview),l.preview=o}})}function Se(e,t="classic"){const i=e.infos;return t==="classic"?(U(i[0].size)+Ce)/2:(U(i[0].size)-U(i[i.length-1].size))/2}function le(e,t){if(!e)return null;const i=e.infos.map(l=>l.color),s=G(t.type==="full"?i:t.type==="above"?i.slice(0,3):i.slice(2,5),{width:t.width,height:t.height,align:t.rampAlignment,effectList:t.effectList});return s.className=Ke.colorRamp,t.opacity!=null&&(s.style.opacity=t.opacity.toString()),s}function Oe(e,t,i,s="vertical"){let l=0;const r=e.infos,n=Math.floor(r.length/2),a=t==="full"||t==="above"?0:n,o=t==="full"||t==="below"?r.length-1:n;for(let u=a;u<=o;u++)i&&u===n?l+=s==="horizontal"?Dt:Ge:l+=U(r[u].size)+(s==="horizontal"?Qe:Ce);return Math.round(l)}function re(e,t,i,s="vertical"){const l=Oe(e,t,i,s),r=e.infos,n=Math.floor(r.length/2),a=t==="full"||t==="above"?0:n,o=t==="full"||t==="below"?r.length-1:n,u=t==="full"?r[a].size+r[o].size:t==="above"?r[a].size:r[o].size,c=i?s==="vertical"?Ge:Dt:0,h=s==="vertical"?Ce*(t==="full"?2:1):Qe*(t==="full"?2:1);return Math.round(l-(U(u)/2+c/2+h/2))}function Pt(e,t,i="vertical"){const s=e.infos;let l=s.find(({type:o})=>o==="size-ramp"),r=s.find(({type:o})=>o==="color-ramp");var n,a;return l&&(l=O({},l),l.infos=[...l.infos],qt(l,t,i,!0)),r&&(r=O({},r),r.infos=[...r.infos]),i==="horizontal"&&((n=l)==null||n.infos.reverse(),(a=r)==null||a.infos.reverse()),{sizeRampElement:l,colorRampElement:r}}function Ht(e,t="vertical"){const i=e.infos;let s=i.find(({type:a})=>a==="size-ramp"),l=i.find(({type:a})=>a==="color-ramp");var r,n;return s&&(s=O({},s),s.infos=[...s.infos],qt(s,null,t,!1)),l&&(l=O({},l),l.infos=[...l.infos]),t==="horizontal"&&((r=s)==null||r.infos.reverse(),(n=l)==null||n.infos.reverse()),{sizeRampElement:s,colorRampElement:l}}function Ws(e,t){return t}function z(e){const t=this;e.appendChild(t)}function ne(e,t,i){if(!t)return;if(typeof t=="string"||typeof t=="number")return t;if("value"in t||"unit"in t)return Te(e.dotValue,t);if("colorName"in t||"bandName"in t)return e[t.colorName]+": "+(e[t.bandName]||t.bandName);if("showCount"in t)return t.showCount?e.clusterCountTitle:null;let s=null;return Ws(t,i)?s=t.ratioPercentTotal?"showRatioPercentTotal":t.ratioPercent?"showRatioPercent":t.ratio?"showRatio":t.normField?"showNormField":t.field?"showField":null:Ut(t,i)&&(s=t.normField?"showNormField":t.normByPct?"showNormPct":t.field?"showField":null),s?Te(s==="showField"?"{field}":e[s],{field:t.field,normField:t.normField}):null}function Ut(e,t){return!t}function Wt(e,t){return!!(t&&t==="Stretched"&&e.version>=10.3&&e.declaredClass==="esri.layers.ImageryLayer")}const b={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",sizeRampPreview:"esri-legend--card__size-ramp-preview",rampContainer:"esri-legend__ramps",sizeRampHorizontal:"esri-legend__size-ramp--horizontal",rampLabelsContainer:"esri-legend__ramp-labels",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden"},js=25,Gs=25,Qs=768,Ks=100;var de;(function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"})(de||(de={}));const Js="#ddd",X=window.devicePixelRatio;function Xs(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const i=e.symbolLayers.getItemAt(t-1),s=i.resource&&i.resource.primitive;return s==="circle"||s==="cross"||s==="kite"||s==="sphere"||s==="cube"||s==="diamond"}{const t=e.style;return t==="circle"||t==="diamond"||t==="cross"}}}function Ys(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const i=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return i==="triangle"||i==="cone"||i==="tetrahedron"}return e.style==="triangle"}}let B=class extends He{constructor(e,t){super(e,t),this._handles=new Ie,this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout=de.Stack,this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.own([this.watch("activeLayerInfos",e=>{this._handles.removeAll(),this._watchForSectionChanges(e)})])}destroy(){this._handles.destroy(),this._handles=null}render(){this._hasIndicators=this.layout===de.Auto&&this.view.container.clientWidth<=Qs||this.layout===de.Stack;const e=this.activeLayerInfos,t=e&&e.toArray().map(a=>this._renderLegendForLayer(a)).filter(a=>!!a);this._hasIndicators?this._selectedSectionName&&this._sectionNames.indexOf(this._selectedSectionName)!==-1||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const i=this._sectionNames.length,s=this._sectionNames.map((a,o)=>{const u=Te(this.messagesCommon.pagination.pageText,{index:o+1,total:i});return d("div",{key:a,role:"tab",id:a,"aria-label":u,"aria-controls":`${a}-panel`,"aria-selected":(this._selectedSectionName===a).toString(),tabIndex:this._selectedSectionName===a?0:-1,title:u,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(b.indicator,{[b.activated]:this._selectedSectionName===a}),"data-section-name":a})}),l=this._hasIndicators&&i>1?d("div",{class:b.indicatorContainer,key:"carousel-navigation",role:"tablist"},s):null,r=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):t&&t.length?t:null,n={[b.stacked]:this._hasIndicators};return d("div",{class:this.classes(b.base,n)},r||d("div",{class:b.message},this.messages.noLegend),l)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,i=t==="ArrowLeft"?-1:1,s=e.target.getAttribute("data-section-name"),l=this._sectionNames.indexOf(s),r=this._sectionNames;let n=null;l!==-1&&(r[l+i]?n=document.getElementById(r[l+i]):t==="ArrowLeft"?n=document.getElementById(r[r.length-1]):t==="ArrowRight"&&(n=document.getElementById(r[0])),n&&n.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach(i=>{const s=`activeLayerInfo-${i.layer.uid}-version-change`;this._handles.remove(s),this._watchForSectionChanges(i.children),this._handles.add(i.watch("version",()=>this._generateSectionNames()),s)});const t="activeLayerInfos-collection-change";this._handles.remove(t),this._handles.add(e.on("change",()=>this._watchForSectionChanges(e)),t)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,i){return`${this.id}${e.uid}-type-${t.type}-${i}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach((t,i)=>{this._sectionNames.push(this._getSectionName(e.layer,t,i))})}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map(i=>this._renderLegendForLayer(i)).toArray();return d("div",{key:e.layer.uid,class:this.classes(b.service,b.groupLayer)},d("div",{class:b.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const i=t.some(r=>r.type==="relationship-ramp"),s=t.map((r,n)=>this._renderLegendForElement(r,e,n,i)).filter(r=>!!r);if(!s.length)return null;const l={[b.groupLayerChild]:!!e.parent};return d("div",{key:e.layer.uid,class:this.classes(b.service,l)},d("div",{class:b.serviceCaptionContainer},d("div",{class:b.serviceCaptionText},e.title)),d("div",{class:b.serviceContent},s))}}_renderLegendForElement(e,t,i,s=!1){const l=e.type==="color-ramp",r=e.type==="opacity-ramp",n=e.type==="size-ramp",a=t.layer;let o=null;if(typeof e.title=="string")o=e.title;else if(e.title){const m=e.title,_=ne(this.messages,m,l||r);o=m.title?`${m.title} (${_})`:_}const u=this._getSectionName(a,e,i),c=this._hasIndicators?d("div",null,d(be,{level:this.headingLevel,class:b.carouselTitle},t.title),d(be,{level:Li(this.headingLevel),class:b.layerCaption},o)):o?d(be,{level:this.headingLevel,class:b.layerCaption},o):null,h=t.effectList;let p=null;if(e.type==="symbol-table"){const m=e.infos.map((_,y)=>this._renderLegendForElementInfo(_,t,e.legendType,y)).filter(_=>!!_);if(m.length){const _=m[0].properties.classes&&m[0].properties.classes[b.symbolRow],y={[b.labelContainer]:!_&&!s,[b.relationshipLabelContainer]:s};p=d("div",{class:this.classes(y)},m)}}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"?p=this._renderLegendForRamp(e,a.opacity,h):n?p=this._renderSizeRamp(e,a.opacity):e.type==="relationship-ramp"?p=Ot(e,this.id,a.opacity,h):e.type==="univariate-above-and-below-ramp"?p=this._renderUnivariateAboveAndBelowRamp(e,a.opacity,h):e.type==="univariate-color-size-ramp"&&(p=this._renderUnivariateColorSizeRamp(e,a.opacity,h));if(!p)return null;const f=d("div",{key:u,class:b.section,id:`${u}-panel`,role:"tabpanel","aria-labelledby":u,tabIndex:0},[c,p]);return this._sectionMap.set(u,f),f}_renderUnivariateAboveAndBelowRamp(e,t,i){const{sizeRampElement:s,colorRampElement:l}=Pt(e,t,"horizontal");if(!s)return null;const r=Oe(s,"full",!0,"horizontal"),n=re(s,"above",!0,"horizontal"),a=re(s,"below",!0,"horizontal"),o=12,u=le(l,{width:n,height:o,rampAlignment:"horizontal",opacity:t,type:"above",effectList:i}),c=le(l,{width:a,height:o,rampAlignment:"horizontal",opacity:t,type:"below",effectList:i}),h=Se(s,"card"),p=s.infos.map(C=>C.label),f=p.length-1,m=p.map((C,S)=>S===0||S===f?d("div",{key:S},C):null),_={display:"flex",flexDirection:"column"},y={display:"flex",flexDirection:"row"},w={marginTop:"3px",display:"flex"};xe(this.container)?w.marginRight=`${h}px`:w.marginLeft=`${h}px`;const g={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return d("div",{class:b.layerRow,key:"size-ramp-preview",styles:_},d("div",{class:this.classes(b.symbolContainer,b.sizeRampHorizontal),styles:y},s.infos.map((C,S)=>d("div",{key:S,class:b.symbol,bind:C.preview,afterCreate:z}))),u?d("div",{class:b.univariateAboveAndBelowColorRamp,styles:w,key:"color-ramp-preview"},d("div",{bind:u,afterCreate:z}),d("div",{bind:c,afterCreate:z})):null,d("div",{class:b.layerInfo},d("div",{class:b.rampLabelsContainer,styles:g},m)))}_renderUnivariateColorSizeRamp(e,t,i){const{sizeRampElement:s,colorRampElement:l}=Ht(e,"horizontal");if(!s)return null;const r=Oe(s,"full",!1,"horizontal"),n=re(s,"full",!1,"horizontal"),a=le(l,{width:n,height:12,rampAlignment:"horizontal",opacity:t,type:"full",effectList:i}),o=Se(s,"card"),u=s.infos.length-1,c=s.infos.map((_,y)=>y===0||y===u?d("div",{key:y},_.label):null),h={display:"flex",flexDirection:"column"},p={display:"flex",flexDirection:"row"},f={marginTop:"3px",display:"flex"};xe(this.container)?f.marginRight=`${o}px`:f.marginLeft=`${o}px`;const m={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return d("div",{class:b.layerRow,key:"size-ramp-preview",styles:h},d("div",{class:this.classes(b.symbolContainer,b.sizeRampHorizontal),styles:p},s.infos.map((_,y)=>d("div",{key:y,class:b.symbol,bind:_.preview,afterCreate:z}))),d("div",{class:b.univariateAboveAndBelowColorRamp,styles:f,key:"color-ramp-preview"},d("div",{bind:a,afterCreate:z})),d("div",{class:b.layerInfo},d("div",{class:b.rampLabelsContainer,styles:m},c)))}_renderLegendForElementInfo(e,t,i,s){const l=t.layer;if(e.type)return this._renderLegendForElement(e,t,s);const r=Wt(l,i);if(e.preview){var n,a;if(!e.symbol||e.symbol.type.indexOf("simple-fill")===-1){if(!e.label)return d("div",{key:s,bind:e.preview,afterCreate:z});const A={[b.symbolCell]:this._hasIndicators};return d("div",{key:s,class:this.classes(b.layerRow,{[b.symbolRow]:this._hasIndicators})},d("div",{class:this.classes(A),bind:e.preview,afterCreate:z}),d("div",{class:this.classes(b.imageLabel,{[b.labelCell]:this._hasIndicators})},ne(this.messages,e.label,!1)||""))}let o=255,u=255,c=255,h=0,p=255,f=255,m=255,_=0;const y=e.symbol.color&&e.symbol.color.a,w=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;y&&(o=e.symbol.color.r,u=e.symbol.color.g,c=e.symbol.color.b,h=e.symbol.color.a*l.opacity),w&&(p=e.symbol.outline.color.r,f=e.symbol.outline.color.g,m=e.symbol.outline.color.b,_=e.symbol.outline.color.a*l.opacity);const g=(n=(a=e.symbol.color)==null?void 0:a.isBright)==null||n,C=g?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",S={background:y?`rgba(${o}, ${u}, ${c}, ${h})`:"none",color:g?"black":"white",textShadow:`-1px -1px 0 ${C},
                                              1px -1px 0 ${C},
                                              -1px 1px 0 ${C},
                                              1px 1px 0 ${C}`,border:w?`1px solid rgba(${p}, ${f}, ${m}, ${_})`:"none",filter:ze(t.effectList)};return d("div",{key:s,class:b.layerRow},d("div",{class:b.labelElement,styles:S}," ",e.label," "))}if(e.src){const o=this._renderImage(e,l,r);return d("div",{key:s,class:b.layerRow},o,d("div",{class:b.imageLabel},e.label||""))}}_renderImage(e,t,i){const{label:s,src:l,opacity:r}=e,n={[b.imageryLayerStretchedImage]:i,[b.symbol]:!i},a={opacity:`${r!=null?r:t.opacity}`};return d("img",{alt:ne(this.messages,s,!1),src:l,border:0,width:e.width,height:e.height,class:this.classes(n),styles:a})}_renderSizeRampLines(e){const t=e.infos,i=t[0],s=t[t.length-1],l=i.symbol,r=this._hasIndicators,n=U(i.size+i.outlineSize)*X,a=U(s.size+s.outlineSize)*X,o=r?n:n+50*X,u=r?n/2+50*X:n,c=Ys(l),h=Xs(l),p=document.createElement("canvas");p.width=o,p.height=u,p.style.width=p.width/X+"px",p.style.height=p.height/X+"px";const f=p.getContext("2d");if(r){f.beginPath();const m=0,_=0,y=o/2-a/2,w=u;f.moveTo(m,_),f.lineTo(y,w);const g=o,C=0,S=o/2+a/2,A=u;f.moveTo(g,C),f.lineTo(S,A)}else{f.beginPath();const m=0,_=u/2-a/2,y=o,w=0;f.moveTo(m,_),f.lineTo(y,w);const g=0,C=u/2+a/2,S=o,A=u;f.moveTo(g,C),f.lineTo(S,A)}return f.strokeStyle=Js,f.stroke(),d("div",{bind:p,afterCreate:z,styles:r?{display:"flex",marginTop:`-${c?0:h?n/2:0}px`,marginBottom:`-${c?a:h?a/2:0}px`}:{display:"flex",marginRight:`-${c?0:h?n/2:0}px`,marginLeft:`-${c?0:h?a/2:0}px`}})}_renderSizeRamp(e,t){const i=e.infos,s=i[0].label,l=i[i.length-1].label;let r=i[0].preview,n=i[i.length-1].preview;const a=this._hasIndicators,o={"flex-direction":a?"column":"row-reverse"};r&&(r=r.cloneNode(!0),r.style.display="flex"),n&&(n=n.cloneNode(!0),n.style.display="flex");const u={opacity:t!=null?`${t}`:""};return d("div",{class:this.classes(b.layerRow,{[b.sizeRampRow]:a})},d("div",{class:b.rampLabel},a?s:l),d("div",{class:b.sizeRampContainer,styles:o},d("div",{bind:r,afterCreate:z,class:b.sizeRampPreview,styles:u}),this._renderSizeRampLines(e),d("div",{bind:n,afterCreate:z,class:b.sizeRampContainer,styles:u})),d("div",{class:b.rampLabel},a?l:s))}_renderLegendForRamp(e,t,i){const s=e.infos,l=e.type==="heatmap-ramp",r=s.length-1,n=Gs,a=r>2&&!l?js*r:Ks,o=a+20,u=10,c=s.slice(0).reverse();c.forEach((A,$)=>{A.offset=l?A.ratio:$/r});const h=c.length-1,p=c.length%2!=0&&c[c.length/2|0],f=p&&d("div",{class:b.intervalSeparatorsContainer},d("div",{class:b.intervalSeparator},"|"),d("div",{class:b.rampLabel},p.label)),m=s[s.length-1].label,_=s[0].label,y=[[{shape:{type:"path",path:`M0 ${n/2} L${u} 0 L${u} ${n} Z`},fill:c[0].color,stroke:{width:0}},{shape:{type:"rect",x:u,y:0,width:a,height:n},fill:{type:"linear",x1:u,y1:0,x2:a+u,y2:0,colors:c},stroke:{width:0}},{shape:{type:"path",path:`M${a+u} 0 L${o} ${n/2} L${a+u} ${n} Z`},fill:c[h].color,stroke:{width:0}}]],w=Ti(y,o,n),{messages:g}=this,C={filter:ze(i),opacity:t==null?null:`${t}`},S={justifyContent:"center"};return d("div",{class:b.layerRow,styles:S},d("div",{class:b.rampLabel},l?g[m]:m),d("div",{class:b.symbolContainer},d("div",{styles:C},w),f),d("div",{class:b.rampLabel},l?g[_]:_))}};v([I()],B.prototype,"activeLayerInfos",void 0),v([I()],B.prototype,"headingLevel",void 0),v([I()],B.prototype,"layout",void 0),v([I(),_e("esri/widgets/Legend/t9n/Legend")],B.prototype,"messages",void 0),v([I(),_e("esri/t9n/common")],B.prototype,"messagesCommon",void 0),v([I({readOnly:!0})],B.prototype,"type",void 0),v([I()],B.prototype,"view",void 0),v([_i()],B.prototype,"_selectSection",null),B=v([ye("esri.widgets.Legend.styles.Card")],B);const Re=B,L={service:"esri-legend__service",label:"esri-legend__service-label",layer:"esri-legend__layer",groupLayer:"esri-legend__group-layer",groupLayerChild:"esri-legend__group-layer-child",layerTable:"esri-legend__layer-table",layerTableSizeRamp:"esri-legend__layer-table--size-ramp",layerChildTable:"esri-legend__layer-child-table",layerCaption:"esri-legend__layer-caption",layerBody:"esri-legend__layer-body",layerRow:"esri-legend__layer-row",layerCell:"esri-legend__layer-cell",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",imageryLayerStretchedImage:"esri-legend__imagery-layer-image--stretched",imageryLayerCellStretched:"esri-legend__imagery-layer-cell--stretched",imageryLayerInfoStretched:"esri-legend__imagery-layer-info--stretched",symbolContainer:"esri-legend__layer-cell esri-legend__layer-cell--symbols",symbol:"esri-legend__symbol",rampContainer:"esri-legend__ramps",sizeRamp:"esri-legend__size-ramp",colorRamp:"esri-legend__color-ramp",opacityRamp:"esri-legend__opacity-ramp",borderlessRamp:"esri-legend__borderless-ramp",rampTick:"esri-legend__ramp-tick",rampFirstTick:"esri-legend__ramp-tick-first",rampLastTick:"esri-legend__ramp-tick-last",rampLabelsContainer:"esri-legend__ramp-labels",rampLabel:"esri-legend__ramp-label",univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",univariateAboveAndBelowLabel:"esri-univariate-above-and-below-ramp__label",message:"esri-legend__message",header:"esri-widget__heading",hidden:"esri-hidden"},Zs="esri-legend__",el=24,ct={display:"flex",alignItems:"flex-start"},Ve={marginLeft:"3px"},Y={display:"table-cell",verticalAlign:"middle"};let Q=class extends He{constructor(e,t){super(e,t),this.activeLayerInfos=null,this.headingLevel=3,this.messages=null,this.type="classic"}render(){const e=this.activeLayerInfos,t=e&&e.toArray().map(i=>this._renderLegendForLayer(i)).filter(i=>!!i);return d("div",null,t&&t.length?t:d("div",{class:L.message},this.messages.noLegend))}_renderLegendForLayer(e){if(!e.ready)return null;const t=!!e.children.length,i=`${Zs}${e.layer.uid}-version-${e.version}`,s=e.title?be({level:this.headingLevel,class:this.classes(L.header,L.label)},e.title):null;if(t){const l=e.children.map(r=>this._renderLegendForLayer(r)).toArray();return d("div",{key:i,class:this.classes(L.service,L.groupLayer)},s,l)}{const l=e.legendElements;if(l&&!l.length)return null;const r=l.map(a=>this._renderLegendForElement(a,e.layer,e.effectList)).filter(a=>!!a);if(!r.length)return null;const n={[L.groupLayerChild]:!!e.parent};return d("div",{key:i,class:this.classes(L.service,n),tabIndex:0},s,d("div",{class:L.layer},r))}}_renderLegendForElement(e,t,i,s){const l=e.type==="color-ramp",r=e.type==="opacity-ramp",n=e.type==="size-ramp";let a=null;if(e.type==="symbol-table"||n){const f=e.infos.map(m=>this._renderLegendForElementInfo(m,t,i,n,e.legendType)).filter(m=>!!m);f.length&&(a=d("div",{class:L.layerBody},f))}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"||e.type==="stretch-ramp"?a=this._renderLegendForRamp(e,t.opacity):e.type==="relationship-ramp"?a=Ot(e,this.id,t.opacity,i):e.type==="univariate-above-and-below-ramp"?a=this._renderUnivariateAboveAndBelowRamp(e,t.opacity,i):e.type==="univariate-color-size-ramp"&&(a=this._renderUnivariateColorSizeRamp(e,t.opacity,i));if(!a)return null;const o=e.title;let u=null;if(typeof o=="string")u=o;else if(o){const f=ne(this.messages,o,l||r);u=Ut(o,l||r)&&o.title?`${o.title} (${f})`:f}const c=s?L.layerChildTable:L.layerTable,h=u?d("div",{class:L.layerCaption},u):null,p={[L.layerTableSizeRamp]:n||!s};return d("div",{class:this.classes(c,p)},h,a)}_renderUnivariateAboveAndBelowRamp(e,t,i){const{sizeRampElement:s,colorRampElement:l}=Pt(e,t);if(!s)return null;const r=re(s,"above",!0),n=re(s,"below",!0),a=12,o=le(l,{width:a,height:r,rampAlignment:"vertical",opacity:t,type:"above",effectList:i}),u=le(l,{width:a,height:n,rampAlignment:"vertical",opacity:t,type:"below",effectList:i}),c=Se(s),h=s.infos.map(S=>S.label),p=h.map((S,A)=>A===0?d("div",{key:A,class:S?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},S):A===2?d("div",null):null),f=h.length-1,m=Math.floor(h.length/2),_=h.map((S,A)=>A===m||A===f?d("div",{key:A,class:S?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},S):null),y={display:"table-cell",verticalAlign:"middle"},w={marginTop:`${c}px`},g={height:`${r}px`},C={height:`${n}px`};return d("div",{key:"univariate-above-and-below-ramp-preview",styles:ct},d("div",{class:L.layerBody},s.infos.map((S,A)=>d("div",{class:this.classes(L.layerRow,L.sizeRamp)},d("div",{class:L.symbol,styles:y,bind:S.preview,afterCreate:z}),o||A%2!=0?null:d("div",{class:L.layerInfo},h[A])))),o?d("div",{styles:w,key:"color-ramp-preview"},d("div",{styles:Ve},d("div",{styles:Y},d("div",{class:L.rampContainer,bind:o,afterCreate:z})),d("div",{styles:Y},d("div",{class:L.rampLabelsContainer,styles:g},p))),d("div",{styles:Ve},d("div",{styles:Y},d("div",{class:L.rampContainer,bind:u,afterCreate:z})),d("div",{styles:Y},d("div",{class:L.rampLabelsContainer,styles:C},_)))):null)}_renderUnivariateColorSizeRamp(e,t,i){const{sizeRampElement:s,colorRampElement:l}=Ht(e);if(!s)return null;const r=Se(s),n=12,a=re(s,"full",!1),o=le(l,{width:n,height:a,rampAlignment:"vertical",opacity:t,type:"full",effectList:i}),u=s.infos.length-1,c=s.infos.map((m,_)=>_===0||_===u?d("div",{key:_,class:m.label?l?L.univariateAboveAndBelowLabel:L.rampLabel:null},m.label):null),h={display:"table-cell",verticalAlign:"middle"},p={marginTop:`${r}px`},f={height:`${a}px`};return d("div",{key:"univariate-above-and-below-ramp-preview",styles:ct},d("div",{class:L.layerBody},s.infos.map(m=>d("div",{class:this.classes(L.layerRow,L.sizeRamp)},d("div",{class:L.symbol,styles:h,bind:m.preview,afterCreate:z})))),d("div",{styles:p,key:"color-ramp-preview"},d("div",{styles:Ve},d("div",{styles:Y},d("div",{class:L.rampContainer,bind:o,afterCreate:z})),d("div",{styles:Y},d("div",{class:L.rampLabelsContainer,styles:f},c)))))}_renderLegendForRamp(e,t){const i=e.infos,s=e.type==="opacity-ramp",l=e.type==="heatmap-ramp",r=e.type==="stretch-ramp",n=e.preview,a=s?L.opacityRamp:"";n.className=`${L.colorRamp} ${a}`,t!=null&&(n.style.opacity=t.toString());const o=i.map(h=>d("div",{class:h.label?L.rampLabel:null},l?this.messages[h.label]:r?this._getStretchStopLabel(h):h.label)),u={width:`${el}px`},c={height:n.style.height};return d("div",{class:L.layerRow},d("div",{class:L.symbolContainer,styles:u},d("div",{class:L.rampContainer,bind:n,afterCreate:z})),d("div",{class:L.layerInfo},d("div",{class:L.rampLabelsContainer,styles:c},o)))}_getStretchStopLabel(e){return e.label?this.messages[e.label]+": "+(typeof e.value=="string"?e.value:De(e.value,{style:"decimal",notation:e.value.toString().indexOf("e")>-1?"scientific":"standard"})):""}_renderLegendForElementInfo(e,t,i,s,l){if(e.type)return this._renderLegendForElement(e,t,i,!0);let r=null;const n=Wt(t,l);if(e.preview?r=d("div",{class:L.symbol,bind:e.preview,afterCreate:z}):e.src&&(r=this._renderImage(e,t,n)),!r)return null;const a={[L.imageryLayerInfoStretched]:n},o={[L.imageryLayerInfoStretched]:n,[L.sizeRamp]:!n&&s};return d("div",{class:L.layerRow},d("div",{class:this.classes(L.symbolContainer,o)},r),d("div",{class:this.classes(L.layerInfo,a)},ne(this.messages,e.label,!1)||""))}_renderImage(e,t,i){const{label:s,src:l,opacity:r}=e,n={[L.imageryLayerStretchedImage]:i,[L.symbol]:!i},a={opacity:`${r!=null?r:t.opacity}`};return d("img",{alt:ne(this.messages,s,!1),src:l,border:0,width:e.width,height:e.height,class:this.classes(n),styles:a})}};v([I()],Q.prototype,"activeLayerInfos",void 0),v([I()],Q.prototype,"headingLevel",void 0),v([I(),_e("esri/widgets/Legend/t9n/Legend")],Q.prototype,"messages",void 0),v([I({readOnly:!0})],Q.prototype,"type",void 0),Q=v([ye("esri.widgets.Legend.styles.Classic")],Q);const Z=Q,fe={base:"esri-legend",widget:"esri-widget",panel:"esri-widget--panel",widgetIcon:"esri-icon-layer-list"};let x=class extends He{constructor(e,t){super(e,t),this._handles=new Ie,this.activeLayerInfos=null,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.headingLevel=3,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.iconClass=fe.widgetIcon,this.label=void 0,this.layerInfos=null,this.messages=null,this.style=new Z,this.view=null,this.viewModel=new Os}initialize(){this.own(ge(this,"view","resize",()=>this.scheduleRender()),ge(this,"activeLayerInfos","change",()=>this._refreshActiveLayerInfos(this.activeLayerInfos)),k(this,"headingLevel",e=>{const{style:t}=this;t&&(t.headingLevel=e)}),ue(this,"style",(e,t)=>{t&&e!==t&&t.destroy(),e&&(e.activeLayerInfos=this.activeLayerInfos,e.type==="card"&&(e.view=this.view),e.headingLevel=this.headingLevel)}))}destroy(){this._handles.destroy(),this._handles=null}castStyle(e){if(e instanceof Re||e instanceof Z)return e;if(typeof e=="string")return e==="card"?new Re:new Z;if(e&&typeof e.type=="string"){const t=O({},e);return delete t.type,new(e.type==="card"?Re:Z)(t)}return new Z}render(){return d("div",{class:this.classes(fe.base,fe.widget,this.style instanceof Z?fe.panel:null)},this.style.render())}_refreshActiveLayerInfos(e){this._handles.removeAll(),e.forEach(t=>this._renderOnActiveLayerInfoChange(t)),this.scheduleRender()}_renderOnActiveLayerInfoChange(e){const t=ue(e,"version",()=>this.scheduleRender());this._handles.add(t,`version_${e.layer.uid}`);const i=ge(e,"children","change",()=>{e.children.forEach(s=>this._renderOnActiveLayerInfoChange(s))});this._handles.add(i,`children_${e.layer.uid}`),e.children.forEach(s=>this._renderOnActiveLayerInfoChange(s))}};v([P("viewModel.activeLayerInfos")],x.prototype,"activeLayerInfos",void 0),v([P("viewModel.basemapLegendVisible")],x.prototype,"basemapLegendVisible",void 0),v([P("viewModel.groundLegendVisible")],x.prototype,"groundLegendVisible",void 0),v([I()],x.prototype,"headingLevel",void 0),v([P("viewModel.hideLayersNotInCurrentView")],x.prototype,"hideLayersNotInCurrentView",void 0),v([P("viewModel.keepCacheOnDestroy")],x.prototype,"keepCacheOnDestroy",void 0),v([P("viewModel.respectLayerVisibility")],x.prototype,"respectLayerVisibility",void 0),v([I()],x.prototype,"iconClass",void 0),v([I({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],x.prototype,"label",void 0),v([P("viewModel.layerInfos")],x.prototype,"layerInfos",void 0),v([I(),_e("esri/widgets/Legend/t9n/Legend")],x.prototype,"messages",void 0),v([I()],x.prototype,"style",void 0),v([wi("style")],x.prototype,"castStyle",null),v([P("viewModel.view")],x.prototype,"view",void 0),v([I()],x.prototype,"viewModel",void 0),x=v([ye("esri.widgets.Legend")],x);const dl=x;export{dl as default};
