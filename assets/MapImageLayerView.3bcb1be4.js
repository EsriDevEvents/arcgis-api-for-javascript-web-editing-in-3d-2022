var S=Object.defineProperty,M=Object.defineProperties;var O=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var T=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var I=(r,a,e)=>a in r?S(r,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[a]=e,b=(r,a)=>{for(var e in a||(a={}))T.call(a,e)&&I(r,e,a[e]);if(P)for(var e of P(a))_.call(a,e)&&I(r,e,a[e]);return r},A=(r,a)=>M(r,O(a));import{ac as i,ad as n,mj as j,ae as z,V as G,a8 as u,ka as N,mz as Q,gr as R,gI as $}from"./vendor.1dc52be5.js";import{c as k}from"./ExportImageParameters.70091022.js";import{t as q,d as D}from"./popupUtils.b61067f9.js";const H=r=>{let a=class extends r{initialize(){this.exportImageParameters=new k({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var e;return(e=this.exportImageParameters)==null||e.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(e,l){const{layer:y}=this;if(!e)return Promise.reject(new G("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:y}));const c=this.get("view.scale"),d=[],h=async t=>{const o=t.minScale===0||c<=t.minScale,s=t.maxScale===0||c>=t.maxScale;if(t.visible&&o&&s){if(t.sublayers)t.sublayers.forEach(h);else if(t.popupEnabled){const p=D(t,A(b({},l),{defaultPopupTemplateEnabled:!1}));u(p)&&d.unshift({sublayer:t,popupTemplate:p})}}},E=y.sublayers.toArray().reverse().map(h);await Promise.all(E);const F=d.map(async({sublayer:t,popupTemplate:o})=>{await t.load().catch(()=>{});const s=t.createQuery(),p=u(l)?l.event:null,f=N({renderer:t.renderer,event:p}),g=this.createFetchPopupFeaturesQueryGeometry(e,f);if(s.geometry=g,s.outFields=await q(t,o),this.layer.type==="map-image"&&"floors"in this.view){var v,w;const V=(v=this.view)==null||(w=v.floors)==null?void 0:w.clone(),m=Q(V,t);u(m)&&(s.where=s.where?`(${s.where}) AND (${m})`:m)}const x=await this._loadArcadeModules(o);return x&&x.arcadeUtils.hasGeometryOperations(o)||(s.maxAllowableOffset=g.width/f),(await t.queryFeatures(s)).features});return(await R(F)).reduce((t,o)=>o.value?[...t,...o.value]:t,[]).filter(t=>t!=null)}canResume(){var e;return!!super.canResume()&&((e=this.timeExtent)==null||!e.isEmpty)}_loadArcadeModules(e){if(e.get("expressionInfos.length")||Array.isArray(e.content)&&e.content.some(l=>l.type==="expression"))return $()}};return i([n()],a.prototype,"exportImageParameters",void 0),i([n({readOnly:!0})],a.prototype,"exportImageVersion",null),i([n()],a.prototype,"layer",void 0),i([n()],a.prototype,"suspended",void 0),i([n(j)],a.prototype,"timeExtent",void 0),a=i([z("esri.views.layers.MapImageLayerView")],a),a};export{H as y};
